<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Simulate dose adaptation in a population — findDose • tdmore</title>

<!-- favicons -->
<link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png" />
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png" />

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script>

<!-- bootstrap-toc -->
<link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script>

<!-- headroom.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>




<meta property="og:title" content="Simulate dose adaptation in a population — findDose" />
<meta property="og:description" content="Simulate dose adaptation in a population" />
<meta property="og:image" content="/logo.svg" />

<meta name="robots" content="noindex" />
<meta name="robots" content="noindex">

<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->



  </head>

  <body data-spy="scroll" data-target="#toc">
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tdmore</a>
        <span class="version label label-warning" data-toggle="tooltip" data-placement="bottom" title="The full API is stable, but sometimes limited">1.2.0.900</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/tdmore.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/tdmore-dev/tdmore/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header>

<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Simulate dose adaptation in a population</h1>
    <small class="dont-index">Source: <a href='https://github.com/tdmore-dev/tdmore/blob/master/R/optimize.R'><code>R/optimize.R</code></a>, <a href='https://github.com/tdmore-dev/tdmore/blob/master/R/proseval.R'><code>R/proseval.R</code></a></small>
    <div class="hidden name"><code>doseSimulation.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Simulate dose adaptation in a population</p>
    </div>

    <pre class="usage"><span class='fu'>findDose</span><span class='op'>(</span>
  <span class='va'>fit</span>,
  regimen <span class='op'>=</span> <span class='va'>fit</span><span class='op'>$</span><span class='va'>regimen</span>,
  doseRows <span class='op'>=</span> <span class='cn'>NULL</span>,
  interval <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span><span class='fl'>0</span>, <span class='fl'>1e+10</span><span class='op'>)</span>,
  <span class='va'>target</span>,
  se.fit <span class='op'>=</span> <span class='cn'>FALSE</span>,
  level <span class='op'>=</span> <span class='fl'>0.95</span>,
  mc.maxpts <span class='op'>=</span> <span class='fl'>100</span>,
  <span class='va'>...</span>
<span class='op'>)</span>

<span class='fu'>findDoses</span><span class='op'>(</span><span class='va'>fit</span>, regimen <span class='op'>=</span> <span class='va'>fit</span><span class='op'>$</span><span class='va'>regimen</span>, targetMetadata <span class='op'>=</span> <span class='cn'>NULL</span><span class='op'>)</span>

<span class='fu'>doseSimulation</span><span class='op'>(</span>
  <span class='va'>x</span>,
  <span class='va'>...</span>,
  <span class='va'>optimize</span>,
  <span class='va'>predict</span>,
  .fit <span class='op'>=</span> <span class='st'>"fit"</span>,
  .iterationFit <span class='op'>=</span> <span class='st'>"iterationFit"</span>,
  .next_observed <span class='op'>=</span> <span class='st'>"next_observed"</span>,
  .next_regimen <span class='op'>=</span> <span class='st'>"next_regimen"</span>,
  .verbose <span class='op'>=</span> <span class='cn'>TRUE</span>
<span class='op'>)</span></pre>

    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a>Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>fit</th>
      <td><p>tdmorefit object</p></td>
    </tr>
    <tr>
      <th>regimen</th>
      <td><p>the treatment regimen to optimize</p></td>
    </tr>
    <tr>
      <th>doseRows</th>
      <td><p>which rows of the regimen to adapt when searching for a new dose, or NULL to take the last one</p></td>
    </tr>
    <tr>
      <th>interval</th>
      <td><p>which interval to search a dose in. Defaults to a ridiculously high range</p></td>
    </tr>
    <tr>
      <th>target</th>
      <td><p>target value, as a data.frame</p></td>
    </tr>
    <tr>
      <th>se.fit</th>
      <td><p>TRUE to provide a confidence interval on the dose prediction, adding columns dose.median, dose.lower and dose.upper</p></td>
    </tr>
    <tr>
      <th>level</th>
      <td><p>the confidence interval on the dose, only used if se.fit is true</p></td>
    </tr>
    <tr>
      <th>mc.maxpts</th>
      <td><p>maximum number of points to sample in Monte Carlo simulation</p></td>
    </tr>
    <tr>
      <th>...</th>
      <td><p>passed to `posthoc`</p></td>
    </tr>
    <tr>
      <th>targetMetadata</th>
      <td><p>defined target troughs as list(min=X, max=Y). If NULL or all NA, taken from the model metadata.</p></td>
    </tr>
    <tr>
      <th>x</th>
      <td><p>tibble with at least a `fit` column</p></td>
    </tr>
    <tr>
      <th>optimize</th>
      <td><p>an optimization function for dose simulation, corresponding to function(fit, regimen, truth), and returning a list(nextTime, regimen)</p></td>
    </tr>
    <tr>
      <th>predict</th>
      <td><p>a prediction function for dose simulation, corresponding to function(truth, newRegimen, nextTime)
If missing, we simply predict using the true fit.
We evaluate the nextObservations time points using the 'true' model and the new regimen.</p></td>
    </tr>
    <tr>
      <th>.fit</th>
      <td><p>Either a string or NULL. If a string, the output will contain a column
with that name, storing the fit</p></td>
    </tr>
    <tr>
      <th>.iterationFit</th>
      <td><p>column name for the iteration fit</p></td>
    </tr>
    <tr>
      <th>.next_observed</th>
      <td><p>What will be the predicted next observation?</p></td>
    </tr>
    <tr>
      <th>.next_regimen</th>
      <td><p>What will be the next regimen?</p></td>
    </tr>
    <tr>
      <th>.verbose</th>
      <td><p>Be verbose when simulating?</p></td>
    </tr>
    </table>

    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>a recommendation object</p>
    <h2 class="hasAnchor" id="details"><a class="anchor" href="#details"></a>Details</h2>

    <p>This tool simulates a dose adaptation run for an individual.
We expect a .fit column in the data, that represents the best model fit for the given subject.
All other columns are passed to the posthoc function when calculating the next fit, except for
the 'observed' data (that is replaced by the simulated data)
and the 'regimen' data (that is replaced by the adapted regimen)</p>
<p>The DoseSimulation iterates as follows:
1. A fit is generated using the up-to-now observed concentrations
2. The optimize method is called with the following arguments:
  `optimize( fit, regimen, truth )`
  It is up to the optimizer to determine how to optimize the treatment regimen.
  The optimizer returns a `list( nextTime=nextObservations, regimen=newRegimen, extra=tibble() )`
  If `nextTime` is not a finite number, we stop the simulation.
  If `nextTime` is missing, we use the next observation from the posthocfit.
3. The predict method is called with the following arguments:
  `predict(truth, newRegimen, nextTime)`
   This predicts the next observation.</p>
    <h2 class="hasAnchor" id="functions"><a class="anchor" href="#functions"></a>Functions</h2>

    
<ul>
<li><p><code>findDose</code>: Find the dose required to hit a target.</p></li>
<li><p><code>findDoses</code>: Optimize the regimen, using the metadata defined by the model</p>
<p>This performs a step-wise optimization of multiple doses.</p></li>
</ul>

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://dplyr.tidyverse.org'>dplyr</a></span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='message'></span>
#&gt; <span class='message'>Attaching package: ‘dplyr’</span></div><div class='output co'>#&gt; <span class='message'>The following objects are masked from ‘package:stats’:</span>
#&gt; <span class='message'></span>
#&gt; <span class='message'>    filter, lag</span></div><div class='output co'>#&gt; <span class='message'>The following objects are masked from ‘package:base’:</span>
#&gt; <span class='message'></span>
#&gt; <span class='message'>    intersect, setdiff, setequal, union</span></div><div class='input'><span class='kw'><a href='https://rdrr.io/r/base/library.html'>library</a></span><span class='op'>(</span><span class='va'><a href='https://ggplot2.tidyverse.org'>ggplot2</a></span><span class='op'>)</span>
<span class='va'>m1</span> <span class='op'>&lt;-</span> <span class='fu'><a href='getModel.html'>getModel</a></span><span class='op'>(</span><span class='op'>)</span>
</div><div class='output co'>#&gt; <span class='message'><span style='color: #00BBBB;'>ℹ</span><span> parameter labels from comments will be replaced by 'label()'</span></div><div class='output co'>#&gt; <span class='message'> </span></div><div class='output co'>#&gt; <span class='message'>qs v0.23.6.</span></div><div class='input'><span class='va'>db</span> <span class='op'>&lt;-</span> <span class='va'>m1</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='as.population.html'>as.population</a></span><span class='op'>(</span>covariates<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/c.html'>c</a></span><span class='op'>(</span>WT<span class='op'>=</span><span class='fl'>70</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
    <span class='fu'><a href='as.sample.html'>as.sample</a></span><span class='op'>(</span>N<span class='op'>=</span><span class='fl'>10</span><span class='op'>)</span>
<span class='va'>optimResult</span> <span class='op'>&lt;-</span> <span class='fu'>doseSimulation</span><span class='op'>(</span><span class='va'>db</span>,
    regimen<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>TIME<span class='op'>=</span><span class='fl'>0</span>, AMT<span class='op'>=</span><span class='fl'>5</span><span class='op'>)</span>,
    optimize<span class='op'>=</span><span class='kw'>function</span><span class='op'>(</span><span class='va'>fit</span>, <span class='va'>regimen</span>, <span class='va'>truth</span><span class='op'>)</span> <span class='op'>{</span>
      <span class='va'>rec</span> <span class='op'>&lt;-</span> <span class='fu'>findDose</span><span class='op'>(</span><span class='va'>fit</span>, target <span class='op'>=</span> <span class='fu'><a href='https://rdrr.io/r/base/data.frame.html'>data.frame</a></span><span class='op'>(</span>TIME<span class='op'>=</span><span class='fl'>24</span>, CONC<span class='op'>=</span><span class='fl'>0.05</span><span class='op'>)</span><span class='op'>)</span>
      <span class='fu'><a href='https://rdrr.io/r/base/list.html'>list</a></span><span class='op'>(</span>
        nextTime<span class='op'>=</span><span class='kw'>if</span><span class='op'>(</span><span class='fu'><a href='https://rdrr.io/r/base/nrow.html'>nrow</a></span><span class='op'>(</span><span class='va'>fit</span><span class='op'>$</span><span class='va'>observed</span><span class='op'>)</span><span class='op'>==</span><span class='fl'>0</span><span class='op'>)</span> <span class='fl'>12</span> <span class='kw'>else</span> <span class='cn'>NA</span>,
        regimen<span class='op'>=</span><span class='va'>rec</span><span class='op'>$</span><span class='va'>regimen</span>
      <span class='op'>)</span>
    <span class='op'>}</span><span class='op'>)</span>
</div><div class='output co'>#&gt; Iteration # 0 
#&gt; Iteration # 1 
#&gt; Iteration # 0 
#&gt; Iteration # 1 
#&gt; Iteration # 0 
#&gt; Iteration # 1 
#&gt; Iteration # 0 
#&gt; Iteration # 1 
#&gt; Iteration # 0 
#&gt; Iteration # 1 
#&gt; Iteration # 0 
#&gt; Iteration # 1 
#&gt; Iteration # 0 
#&gt; Iteration # 1 
#&gt; Iteration # 0 
#&gt; Iteration # 1 
#&gt; Iteration # 0 
#&gt; Iteration # 1 
#&gt; Iteration # 0 
#&gt; Iteration # 1 </div><div class='input'><span class='va'>predictions</span> <span class='op'>&lt;-</span> <span class='va'>optimResult</span> <span class='op'>%&gt;%</span> <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/group_by.html'>ungroup</a></span><span class='op'>(</span><span class='op'>)</span> <span class='op'>%&gt;%</span> <span class='fu'>dplyr</span><span class='fu'>::</span><span class='fu'><a href='https://dplyr.tidyverse.org/reference/mutate.html'>mutate</a></span><span class='op'>(</span>
  ipred <span class='op'>=</span> <span class='fu'>purrr</span><span class='fu'>::</span><span class='fu'><a href='https://purrr.tidyverse.org/reference/map2.html'>map2</a></span><span class='op'>(</span><span class='va'>fit</span>, <span class='va'>next_regimen</span>,
      <span class='op'>~</span><span class='fu'><a href='https://rdrr.io/r/stats/predict.html'>predict</a></span><span class='op'>(</span><span class='va'>.x</span>, regimen<span class='op'>=</span><span class='va'>.y</span>, newdata<span class='op'>=</span><span class='fl'>0</span><span class='op'>:</span><span class='fl'>24</span><span class='op'>)</span><span class='op'>)</span>
<span class='op'>)</span>
<span class='va'>z1</span> <span class='op'>&lt;-</span> <span class='va'>predictions</span> <span class='op'>%&gt;%</span> <span class='fu'>tidyr</span><span class='fu'>::</span><span class='fu'><a href='https://tidyr.tidyverse.org/reference/nest.html'>unnest</a></span><span class='op'>(</span>cols<span class='op'>=</span><span class='va'>ipred</span><span class='op'>)</span> <span class='op'>%&gt;%</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/ggplot.html'>ggplot</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>x<span class='op'>=</span><span class='va'>TIME</span>, y<span class='op'>=</span><span class='va'>CONC</span>, color<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/factor.html'>factor</a></span><span class='op'>(</span><span class='va'>OBS</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span> <span class='op'>+</span>
  <span class='fu'><a href='https://ggplot2.tidyverse.org/reference/geom_path.html'>geom_line</a></span><span class='op'>(</span><span class='fu'><a href='https://ggplot2.tidyverse.org/reference/aes.html'>aes</a></span><span class='op'>(</span>group<span class='op'>=</span><span class='fu'><a href='https://rdrr.io/r/base/interaction.html'>interaction</a></span><span class='op'>(</span><span class='va'>ID</span>,<span class='va'>OBS</span><span class='op'>)</span><span class='op'>)</span><span class='op'>)</span>
<span class='fu'><a href='https://rdrr.io/r/base/print.html'>print</a></span><span class='op'>(</span><span class='va'>z1</span><span class='op'>)</span>
</div><div class='img'><img src='doseSimulation-1.png' alt='' width='700' height='433' /></div></span></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top">
      <h2 data-toc-skip>Contents</h2>
    </nav>
  </div>
</div>


      <footer>
      <div class="copyright">
  <p>Developed by Ruben Faelens, Nicolas Luyckx, Quentin Leirens, FWO TBM Grant.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
   </div>

  


  </body>
</html>


