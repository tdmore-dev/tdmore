<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TDMore, a tool for exploring MIPD performance • tdmore</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="TDMore, a tool for exploring MIPD performance">
<meta property="og:description" content="tdmore">
<meta property="og:image" content="/logo.svg">
<meta name="robots" content="noindex">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tdmore</a>
        <span class="version label label-warning" data-toggle="tooltip" data-placement="bottom" title="The full API is stable, but sometimes limited">1.2.0.900</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/tdmore.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/tdmore-dev/tdmore/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>TDMore, a tool for exploring MIPD performance</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tdmore-dev/tdmore/blob/master/vignettes/tdmore.Rmd"><code>vignettes/tdmore.Rmd</code></a></small>
      <div class="hidden name"><code>tdmore.Rmd</code></div>

    </div>

    
    
<div id="about-this-vignette" class="section level3">
<h3 class="hasAnchor">
<a href="#about-this-vignette" class="anchor"></a>About this vignette</h3>
<p>This shows you how to take a dataset, fit a model, and apply tdmore to investigate predictive performance and precision dosing.</p>
</div>
<div id="source-dataset" class="section level3">
<h3 class="hasAnchor">
<a href="#source-dataset" class="anchor"></a>Source dataset</h3>
<p>We will use a well-known example dataset: <code>pheno</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pheno</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">ID</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>##    ID  TIME  AMT  WT APGR   DV EVID MDV
## 1   1   0.0 25.0 1.4    7   NA    1   1
## 2   1   2.0   NA 1.4    7 17.3    0   0
## 3   1  12.5  3.5 1.4    7   NA    1   1
## 4   1  24.5  3.5 1.4    7   NA    1   1
## 5   1  37.0  3.5 1.4    7   NA    1   1
## 6   1  48.0  3.5 1.4    7   NA    1   1
## 7   1  60.5  3.5 1.4    7   NA    1   1
## 8   1  72.5  3.5 1.4    7   NA    1   1
## 9   1  85.3  3.5 1.4    7   NA    1   1
## 10  1  96.5  3.5 1.4    7   NA    1   1
## 11  1 108.5  3.5 1.4    7   NA    1   1
## 12  1 112.5   NA 1.4    7 31.0    0   0
## 13  2   0.0 15.0 1.5    9   NA    1   1
## 14  2   2.0   NA 1.5    9  9.7    0   0
## 15  2   4.0  3.8 1.5    9   NA    1   1
## 16  2  16.0  3.8 1.5    9   NA    1   1
## 17  2  27.8  3.8 1.5    9   NA    1   1
## 18  2  40.0  3.8 1.5    9   NA    1   1
## 19  2  52.0  3.8 1.5    9   NA    1   1
## 20  2  63.5   NA 1.5    9 24.6    0   0
## 21  2  64.0  3.8 1.5    9   NA    1   1
## 22  2  76.0  3.8 1.5    9   NA    1   1
## 23  2  88.0  3.8 1.5    9   NA    1   1
## 24  2 100.0  3.8 1.5    9   NA    1   1
## 25  2 112.0  3.8 1.5    9   NA    1   1
## 26  2 124.0  3.8 1.5    9   NA    1   1
## 27  2 135.5   NA 1.5    9 33.0    0   0</code></pre>
</div>
<div id="building-your-model" class="section level3">
<h3 class="hasAnchor">
<a href="#building-your-model" class="anchor"></a>Building your model</h3>
<p>We will fit a 1-compartment model to this dataset using nlmixr.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/nlmixrdevelopment/nlmixr">nlmixr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">tidyverse</span><span class="op">)</span>
<span class="va">modelCode</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/pkg/nlmixr/man/ini.html">ini</a></span><span class="op">(</span><span class="op">{</span>
    <span class="va">LTHETA2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span>
    <span class="va">LTHETA3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>
    <span class="co">#variances</span>
    <span class="va">ETA2</span> <span class="op">~</span> <span class="fl">1</span>
    <span class="va">ETA3</span> <span class="op">~</span> <span class="fl">1</span>
    <span class="va">EPS1</span> <span class="op">&lt;-</span> <span class="fl">0.1</span>
  <span class="op">}</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/pkg/nlmixr/man/model.html">model</a></span><span class="op">(</span><span class="op">{</span>
    <span class="va">LWT</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">WT</span> <span class="op">/</span> <span class="fl">70</span><span class="op">)</span>
    <span class="va">V</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">LTHETA2</span><span class="op">+</span><span class="va">LWT</span><span class="op">+</span><span class="va">ETA2</span><span class="op">)</span>
    <span class="va">CL</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">LTHETA3</span><span class="op">+</span><span class="va">LWT</span><span class="op">*</span><span class="fl">0.75</span><span class="op">+</span><span class="va">ETA3</span><span class="op">)</span>

    <span class="va">d</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/TDist.html">dt</a></span><span class="op">(</span><span class="va">centr</span><span class="op">)</span> <span class="op">=</span> <span class="op">-</span><span class="va">CL</span><span class="op">/</span><span class="va">V</span><span class="op">*</span><span class="va">centr</span>
    <span class="va">CONC</span><span class="op">=</span><span class="va">centr</span><span class="op">/</span><span class="va">V</span>
    <span class="va">CONC</span> <span class="op">~</span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="va">EPS1</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">pheno_nlmixr</span> <span class="op">&lt;-</span> <span class="va">pheno</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/nlmixr/man/nlmixr.html">nlmixr</a></span><span class="op">(</span><span class="va">modelCode</span>, data<span class="op">=</span><span class="va">.</span>, est<span class="op">=</span><span class="st">"focei"</span><span class="op">)</span></code></pre></div>
</div>
<div id="adapting-the-model-for-tdmore" class="section level3">
<h3 class="hasAnchor">
<a href="#adapting-the-model-for-tdmore" class="anchor"></a>Adapting the model for tdmore</h3>
<p>An nlmixr model already contains both the structural model and the description of inter-individual variability and residual variability.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tdmore.html">tdmore</a></span><span class="op">(</span><span class="va">pheno_nlmixr</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span></code></pre></div>
<pre><code>## Structural model: RxODE 
## 
## Parameters:
##  name var       cv
##  ETA2   2 1.414214
##  ETA3   1 1.000000
## 
## Covariates: WT 
## 
## Residual error model:
##  name     type additiveError proportionalError
##  CONC constant           0.1                 0</code></pre>
<p>Alternatively, you can specify your model using <code>RxODE</code> or <code>algebraic</code> equations. In these cases, you have to specify the inter-individual variability and residual variability manually.</p>
</div>
<div id="performing-a-posthoc" class="section level3 unnumbered">
<h3 class="hasAnchor">
<a href="#performing-a-posthoc" class="anchor"></a>Performing a posthoc</h3>
<p>Now that we have a model, we can perform a posthoc fit on retrospective data. We will first convert the dataset to tdmore format.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">regimen</span> <span class="op">&lt;-</span> <span class="va">pheno</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">EVID</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">TIME</span>, <span class="va">AMT</span><span class="op">)</span>
<span class="va">observed</span> <span class="op">&lt;-</span> <span class="va">pheno</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">EVID</span><span class="op">==</span><span class="fl">0</span> <span class="op">&amp;</span> <span class="va">MDV</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">TIME</span>, CONC<span class="op">=</span><span class="va">DV</span><span class="op">)</span>
<span class="va">covariates</span> <span class="op">&lt;-</span> <span class="va">pheno</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">TIME</span>, <span class="va">WT</span><span class="op">)</span>
<span class="va">db</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dataTibble.html">dataTibble</a></span><span class="op">(</span>object<span class="op">=</span><span class="va">m1</span>, <span class="va">regimen</span>, <span class="va">observed</span>, <span class="va">covariates</span><span class="op">)</span>

<span class="co">#We will only perform the evaluation for the first 5 subjects, for performance reasons</span>
<span class="va">db</span> <span class="op">&lt;-</span> <span class="va">db</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="op">]</span></code></pre></div>
<p>And then perform a posthoc fit.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">posthocPrediction</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/posthoc.html">posthoc</a></span><span class="op">(</span><span class="va">db</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">posthocPrediction</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 5 x 8
## # Rowwise: 
##      ID object  regimen     observed    covariates    fit     elapsed   ipred   
##   &lt;int&gt; &lt;list&gt;  &lt;list&gt;      &lt;list&gt;      &lt;list&gt;        &lt;list&gt;  &lt;list&gt;    &lt;list&gt;  
## 1     1 &lt;tdmor… &lt;df[,2] [1… &lt;df[,2] [2… &lt;df[,2] [12 … &lt;tdmor… &lt;proc_ti… &lt;df[,2]…
## 2     2 &lt;tdmor… &lt;df[,2] [1… &lt;df[,2] [3… &lt;df[,2] [15 … &lt;tdmor… &lt;proc_ti… &lt;df[,2]…
## 3     3 &lt;tdmor… &lt;df[,2] [1… &lt;df[,2] [3… &lt;df[,2] [15 … &lt;tdmor… &lt;proc_ti… &lt;df[,2]…
## 4     4 &lt;tdmor… &lt;df[,2] [1… &lt;df[,2] [3… &lt;df[,2] [14 … &lt;tdmor… &lt;proc_ti… &lt;df[,2]…
## 5     5 &lt;tdmor… &lt;df[,2] [1… &lt;df[,2] [3… &lt;df[,2] [14 … &lt;tdmor… &lt;proc_ti… &lt;df[,2]…</code></pre>
<p>You can plot a single fit from this easily using <code>autoplot</code>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">posthocPrediction</span><span class="op">$</span><span class="va">fit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, se.fit<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p><img src="tdmore_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
</div>
<div id="quantifying-prediction-accuracy" class="section level3 unnumbered">
<h3 class="hasAnchor">
<a href="#quantifying-prediction-accuracy" class="anchor"></a>Quantifying prediction accuracy</h3>
<p>Let us now explore how well we can predict future concentrations. Proseval creates a tibble with a fit per concentration.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">prosevalResults</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/posthoc.html">proseval</a></span><span class="op">(</span><span class="va">db</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">prosevalResults</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 6 x 9
## # Rowwise: 
##      ID object  regimen    observed   covariates   fit    elapsed  ipred     OBS
##   &lt;int&gt; &lt;list&gt;  &lt;list&gt;     &lt;list&gt;     &lt;list&gt;       &lt;list&gt; &lt;list&gt;   &lt;list&gt;  &lt;dbl&gt;
## 1     1 &lt;tdmor… &lt;df[,2] [… &lt;df[,2] [… &lt;df[,2] [12… &lt;tdmo… &lt;proc_t… &lt;df[,2…     0
## 2     1 &lt;tdmor… &lt;df[,2] [… &lt;df[,2] [… &lt;df[,2] [12… &lt;tdmo… &lt;proc_t… &lt;df[,2…     1
## 3     1 &lt;tdmor… &lt;df[,2] [… &lt;df[,2] [… &lt;df[,2] [12… &lt;tdmo… &lt;proc_t… &lt;df[,2…     2
## 4     2 &lt;tdmor… &lt;df[,2] [… &lt;df[,2] [… &lt;df[,2] [15… &lt;tdmo… &lt;proc_t… &lt;df[,2…     0
## 5     2 &lt;tdmor… &lt;df[,2] [… &lt;df[,2] [… &lt;df[,2] [15… &lt;tdmo… &lt;proc_t… &lt;df[,2…     1
## 6     2 &lt;tdmor… &lt;df[,2] [… &lt;df[,2] [… &lt;df[,2] [15… &lt;tdmo… &lt;proc_t… &lt;df[,2…     2</code></pre>
<p>We can use this data to plot how well we can predict the future for this population. The <code>OBS</code> variable describes how many previous concentrations are included in the fit.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">prosevalResults</span> <span class="op">%&gt;%</span> 
  <span class="fu">unnest</span><span class="op">(</span>cols<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">observed</span>, <span class="va">ipred</span><span class="op">)</span>, names_sep<span class="op">=</span><span class="st">"."</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">OBS</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>INCLUDED <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="va">OBS</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">ipred.TIME</span>, y<span class="op">=</span><span class="va">ipred.CONC</span> <span class="op">-</span> <span class="va">observed.CONC</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>se<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span><span class="op">)</span><span class="op">*</span><span class="va">m1</span><span class="op">$</span><span class="va">res_var</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">sigma</span><span class="op">(</span><span class="op">)</span>, linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">INCLUDED</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">999</span>, by<span class="op">=</span><span class="fl">24</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">OBS</span>, labeller<span class="op">=</span><span class="va">label_both</span><span class="op">)</span></code></pre></div>
<pre><code>## `geom_smooth()` using method = 'loess' and formula 'y ~ x'</code></pre>
<p><img src="tdmore_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<p>The concentration data early post-treatment is insufficient to accurately predict the future time course.</p>
</div>
<div id="exploring-mipd-performance" class="section level3">
<h3 class="hasAnchor">
<a href="#exploring-mipd-performance" class="anchor"></a>Exploring MIPD performance</h3>
<p>We can now simulate precision dosing using this model.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## We need to add some metadata to the model to easily optimize</span>
<span class="va">m2</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/metadata.html">metadata</a></span><span class="op">(</span><span class="fu"><a href="../reference/formulation.html">formulation</a></span><span class="op">(</span><span class="st">"Default"</span>, <span class="st">"mg"</span>, dosing_interval<span class="op">=</span><span class="fl">24</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/metadata.html">metadata</a></span><span class="op">(</span><span class="fu"><a href="../reference/target.html">target</a></span><span class="op">(</span>min<span class="op">=</span><span class="fl">30</span>, max<span class="op">=</span><span class="fl">30</span><span class="op">)</span><span class="op">)</span>

<span class="co">## The modified simulation database:</span>
<span class="co">## keep ID, fit, and covariates</span>
<span class="co">## the fit is used as the "truth" to predict new concentrations</span>
<span class="co">## the new regimen assumes a default 24h-based administration</span>
<span class="va">simulationDb</span> <span class="op">&lt;-</span> <span class="va">posthocPrediction</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">fit</span>, <span class="va">covariates</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>regimen<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>TIME<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">140</span>, by<span class="op">=</span><span class="fl">24</span><span class="op">)</span>, AMT<span class="op">=</span><span class="cn">NA</span>, FORM<span class="op">=</span><span class="st">"Default"</span><span class="op">)</span><span class="op">)</span>,
         object<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span><span class="op">)</span> 

<span class="co">## Adjustment option 1: measure at each trough</span>
<span class="va">measureAtTrough</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fit</span>, <span class="va">regimen</span>, <span class="va">truth</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">observed</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findDose.html">findDoses</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nextTime<span class="op">=</span><span class="va">regimen</span><span class="op">$</span><span class="va">TIME</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="fl">0.01</span>, regimen<span class="op">=</span><span class="va">rec</span><span class="op">$</span><span class="va">regimen</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">now</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">observed</span><span class="op">$</span><span class="va">TIME</span><span class="op">)</span> <span class="op">+</span> <span class="fl">3</span>
    <span class="va">regimen</span><span class="op">$</span><span class="va">FIX</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="op">(</span><span class="va">regimen</span><span class="op">$</span><span class="va">TIME</span> <span class="op">&gt;</span> <span class="va">now</span><span class="op">)</span>
    <span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findDose.html">findDoses</a></span><span class="op">(</span><span class="va">fit</span>, regimen<span class="op">=</span><span class="va">regimen</span><span class="op">)</span>
    <span class="va">nextTime</span> <span class="op">&lt;-</span> <span class="va">regimen</span><span class="op">$</span><span class="va">TIME</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="va">regimen</span><span class="op">$</span><span class="va">FIX</span><span class="op">)</span><span class="op">]</span> <span class="co">#next trough</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nextTime<span class="op">=</span><span class="va">nextTime</span><span class="op">-</span><span class="fl">0.01</span>, regimen<span class="op">=</span><span class="va">rec</span><span class="op">$</span><span class="va">regimen</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="co">## Adjustment option 2: measure 8h before trough, so you can still adapt</span>
<span class="va">measure8hBeforeTrough</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fit</span>, <span class="va">regimen</span>, <span class="va">truth</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">observed</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findDose.html">findDoses</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nextTime<span class="op">=</span><span class="va">regimen</span><span class="op">$</span><span class="va">TIME</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="fl">8</span>, regimen<span class="op">=</span><span class="va">rec</span><span class="op">$</span><span class="va">regimen</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">now</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">observed</span><span class="op">$</span><span class="va">TIME</span><span class="op">)</span> <span class="op">+</span> <span class="fl">3</span>
    <span class="va">regimen</span><span class="op">$</span><span class="va">FIX</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="op">(</span><span class="va">regimen</span><span class="op">$</span><span class="va">TIME</span> <span class="op">&gt;</span> <span class="va">now</span><span class="op">)</span>
    <span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findDose.html">findDoses</a></span><span class="op">(</span><span class="va">fit</span>, regimen<span class="op">=</span><span class="va">regimen</span><span class="op">)</span>
    <span class="va">nextTime</span> <span class="op">&lt;-</span> <span class="va">regimen</span><span class="op">$</span><span class="va">TIME</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="va">regimen</span><span class="op">$</span><span class="va">FIX</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="co">#next trough</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nextTime<span class="op">=</span><span class="va">nextTime</span><span class="op">-</span><span class="fl">8</span>, regimen<span class="op">=</span><span class="va">rec</span><span class="op">$</span><span class="va">regimen</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="co">## Adjustment option 3: rich profile at the beginning</span>
<span class="va">richProfileAtBeginning</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fit</span>, <span class="va">regimen</span>, <span class="va">truth</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">richProfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">8</span>, <span class="fl">10</span><span class="op">)</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">observed</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findDose.html">findDoses</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nextTime<span class="op">=</span><span class="va">richProfile</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, regimen<span class="op">=</span><span class="va">rec</span><span class="op">$</span><span class="va">regimen</span><span class="op">)</span> <span class="op">)</span>
  <span class="op">}</span>
  
  <span class="va">nextTime</span> <span class="op">&lt;-</span> <span class="va">richProfile</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">observed</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span>
  <span class="va">regimen</span><span class="op">$</span><span class="va">FIX</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>
  <span class="va">regimen</span><span class="op">$</span><span class="va">FIX</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span> <span class="co">#loading dose cannot be changed</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">observed</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">richProfile</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findDose.html">findDoses</a></span><span class="op">(</span><span class="va">fit</span>, regimen<span class="op">=</span><span class="va">regimen</span><span class="op">)</span>
    <span class="va">regimen</span> <span class="op">&lt;-</span> <span class="va">rec</span><span class="op">$</span><span class="va">regimen</span>
  <span class="op">}</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nextTime<span class="op">=</span><span class="va">nextTime</span>, regimen<span class="op">=</span><span class="va">regimen</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">simulationResult</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findDose.html">doseSimulation</a></span><span class="op">(</span><span class="va">simulationDb</span>, optimize<span class="op">=</span><span class="va">measureAtTrough</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>method<span class="op">=</span><span class="st">"A. At Trough"</span><span class="op">)</span></code></pre></div>
<pre><code>## Iteration # 0 
## Iteration # 1 
## Iteration # 2 
## Iteration # 3 
## Iteration # 4 
## Iteration # 5 
## Iteration # 0 
## Iteration # 1 
## Iteration # 2 
## Iteration # 3 
## Iteration # 4 
## Iteration # 5 
## Iteration # 0 
## Iteration # 1 
## Iteration # 2 
## Iteration # 3 
## Iteration # 4 
## Iteration # 5 
## Iteration # 0 
## Iteration # 1 
## Iteration # 2 
## Iteration # 3 
## Iteration # 4 
## Iteration # 5 
## Iteration # 0 
## Iteration # 1 
## Iteration # 2 
## Iteration # 3 
## Iteration # 4 
## Iteration # 5</code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">simulationResult2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findDose.html">doseSimulation</a></span><span class="op">(</span><span class="va">simulationDb</span>, optimize<span class="op">=</span><span class="va">measure8hBeforeTrough</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>method<span class="op">=</span><span class="st">"B. 8h before trough"</span><span class="op">)</span></code></pre></div>
<pre><code>## Iteration # 0 
## Iteration # 1 
## Iteration # 2 
## Iteration # 3 
## Iteration # 4 
## Iteration # 5 
## Iteration # 0 
## Iteration # 1 
## Iteration # 2 
## Iteration # 3 
## Iteration # 4 
## Iteration # 5 
## Iteration # 0 
## Iteration # 1 
## Iteration # 2 
## Iteration # 3 
## Iteration # 4 
## Iteration # 5 
## Iteration # 0 
## Iteration # 1 
## Iteration # 2 
## Iteration # 3 
## Iteration # 4 
## Iteration # 5 
## Iteration # 0 
## Iteration # 1 
## Iteration # 2 
## Iteration # 3 
## Iteration # 4 
## Iteration # 5</code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">simulationResult3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findDose.html">doseSimulation</a></span><span class="op">(</span><span class="va">simulationDb</span>, optimize<span class="op">=</span><span class="va">richProfileAtBeginning</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>method<span class="op">=</span><span class="st">"C. Rich profile"</span><span class="op">)</span></code></pre></div>
<pre><code>## Iteration # 0 
## Iteration # 1 
## Iteration # 2 
## Iteration # 3 
## Iteration # 4 
## Iteration # 5 
## Iteration # 6 
## Iteration # 0 
## Iteration # 1 
## Iteration # 2 
## Iteration # 3 
## Iteration # 4 
## Iteration # 5 
## Iteration # 6 
## Iteration # 0 
## Iteration # 1 
## Iteration # 2 
## Iteration # 3 
## Iteration # 4 
## Iteration # 5 
## Iteration # 6 
## Iteration # 0 
## Iteration # 1 
## Iteration # 2 
## Iteration # 3 
## Iteration # 4 
## Iteration # 5 
## Iteration # 6 
## Iteration # 0 
## Iteration # 1 
## Iteration # 2 
## Iteration # 3 
## Iteration # 4 
## Iteration # 5 
## Iteration # 6</code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fullResult</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">simulationResult</span>, <span class="va">simulationResult2</span>, <span class="va">simulationResult3</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">method</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">#only keep the last regimen</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ipred <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">map2</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">next_regimen</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">.x</span>, regimen<span class="op">=</span><span class="va">.y</span>, newdata<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">144</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">fullResult</span><span class="op">)</span></code></pre></div>
<pre><code>## # A tibble: 6 x 12
## # Groups:   ID, method [6]
##      ID covariates   regimen   object  observed  iterationFit next_regimen   OBS
##   &lt;int&gt; &lt;list&gt;       &lt;list&gt;    &lt;list&gt;  &lt;list&gt;    &lt;list&gt;       &lt;list&gt;       &lt;int&gt;
## 1     1 &lt;df[,2] [12… &lt;df[,3] … &lt;tdmor… &lt;df[,6] … &lt;tdmoreft&gt;   &lt;df[,4] [6 …     5
## 2     2 &lt;df[,2] [15… &lt;df[,3] … &lt;tdmor… &lt;df[,6] … &lt;tdmoreft&gt;   &lt;df[,4] [6 …     5
## 3     3 &lt;df[,2] [15… &lt;df[,3] … &lt;tdmor… &lt;df[,6] … &lt;tdmoreft&gt;   &lt;df[,4] [6 …     5
## 4     4 &lt;df[,2] [14… &lt;df[,3] … &lt;tdmor… &lt;df[,6] … &lt;tdmoreft&gt;   &lt;df[,4] [6 …     5
## 5     5 &lt;df[,2] [14… &lt;df[,3] … &lt;tdmor… &lt;df[,6] … &lt;tdmoreft&gt;   &lt;df[,4] [6 …     5
## 6     1 &lt;df[,2] [12… &lt;df[,3] … &lt;tdmor… &lt;df[,6] … &lt;tdmoreft&gt;   &lt;df[,4] [6 …     5
## # … with 4 more variables: next_observed &lt;list&gt;, fit &lt;list&gt;, method &lt;chr&gt;,
## #   ipred &lt;list&gt;</code></pre>
<p>The <code>doseSimulation</code> function has performed an iterative estimate - adapt routine. It uses <code>nextTime</code> to know when to simulate the next concentration sample, re-estimate the individual fit, and allow dose adaptation.</p>
<p>The final result is a dataset detailing every dose adaptation step. The final regimen can be found at the last line for each subject. We use this regimen to predict concentration from 0 to 150 hours. This can be used to show in silico dosing performance.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">fullResult</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">TIME</span>, y<span class="op">=</span><span class="va">CONC</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">.</span> <span class="op">%&gt;%</span> <span class="fu">unnest</span><span class="op">(</span>cols<span class="op">=</span><span class="va">ipred</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/interaction.html">interaction</a></span><span class="op">(</span><span class="va">method</span>,<span class="va">ID</span><span class="op">)</span>, color<span class="op">=</span><span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">.</span> <span class="op">%&gt;%</span> <span class="fu">unnest</span><span class="op">(</span>cols<span class="op">=</span><span class="va">observed</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="fl">30</span>, linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="fl">30</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.96</span>, <span class="op">-</span><span class="fl">1.96</span><span class="op">)</span><span class="op">*</span><span class="va">m1</span><span class="op">$</span><span class="va">res_var</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">add</span>, linetype<span class="op">=</span><span class="fl">2</span>, alpha<span class="op">=</span><span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"none"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">method</span><span class="op">)</span></code></pre></div>
<p><img src="tdmore_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<p>The dots in the above figure show simulated concentration samples, used to refine the individual fit. The lines are the resulting concentrations from the “true” fit.</p>
<p>Conclusion? For our simple example, simulations indicate measuring 8h before trough (strategy B) is the superior approach, as it reaches the target sooner with similar accuracy to measuring at trough (strategy A). Note that the high additive residual error of 0.1 limits the information obtained from each concentration sample.</p>
</div>
<div id="code-appendix" class="section level3">
<h3 class="hasAnchor">
<a href="#code-appendix" class="anchor"></a>Code appendix</h3>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span> 
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tdmore-dev/tdmore">tdmore</a></span><span class="op">)</span>
<span class="va">pheno</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">ID</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/nlmixrdevelopment/nlmixr">nlmixr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">tidyverse</span><span class="op">)</span>
<span class="va">modelCode</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/pkg/nlmixr/man/ini.html">ini</a></span><span class="op">(</span><span class="op">{</span>
    <span class="va">LTHETA2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">50</span><span class="op">)</span>
    <span class="va">LTHETA3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>
    <span class="co">#variances</span>
    <span class="va">ETA2</span> <span class="op">~</span> <span class="fl">1</span>
    <span class="va">ETA3</span> <span class="op">~</span> <span class="fl">1</span>
    <span class="va">EPS1</span> <span class="op">&lt;-</span> <span class="fl">0.1</span>
  <span class="op">}</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/pkg/nlmixr/man/model.html">model</a></span><span class="op">(</span><span class="op">{</span>
    <span class="va">LWT</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">WT</span> <span class="op">/</span> <span class="fl">70</span><span class="op">)</span>
    <span class="va">V</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">LTHETA2</span><span class="op">+</span><span class="va">LWT</span><span class="op">+</span><span class="va">ETA2</span><span class="op">)</span>
    <span class="va">CL</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">LTHETA3</span><span class="op">+</span><span class="va">LWT</span><span class="op">*</span><span class="fl">0.75</span><span class="op">+</span><span class="va">ETA3</span><span class="op">)</span>

    <span class="va">d</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/stats/TDist.html">dt</a></span><span class="op">(</span><span class="va">centr</span><span class="op">)</span> <span class="op">=</span> <span class="op">-</span><span class="va">CL</span><span class="op">/</span><span class="va">V</span><span class="op">*</span><span class="va">centr</span>
    <span class="va">CONC</span><span class="op">=</span><span class="va">centr</span><span class="op">/</span><span class="va">V</span>
    <span class="va">CONC</span> <span class="op">~</span> <span class="fu"><a href="https://magrittr.tidyverse.org/reference/aliases.html">add</a></span><span class="op">(</span><span class="va">EPS1</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">pheno_nlmixr</span> <span class="op">&lt;-</span> <span class="va">pheno</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/nlmixr/man/nlmixr.html">nlmixr</a></span><span class="op">(</span><span class="va">modelCode</span>, data<span class="op">=</span><span class="va">.</span>, est<span class="op">=</span><span class="st">"focei"</span><span class="op">)</span>
<span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tdmore.html">tdmore</a></span><span class="op">(</span><span class="va">pheno_nlmixr</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span>
<span class="va">regimen</span> <span class="op">&lt;-</span> <span class="va">pheno</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">EVID</span><span class="op">==</span><span class="fl">1</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">TIME</span>, <span class="va">AMT</span><span class="op">)</span>
<span class="va">observed</span> <span class="op">&lt;-</span> <span class="va">pheno</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">EVID</span><span class="op">==</span><span class="fl">0</span> <span class="op">&amp;</span> <span class="va">MDV</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">TIME</span>, CONC<span class="op">=</span><span class="va">DV</span><span class="op">)</span>
<span class="va">covariates</span> <span class="op">&lt;-</span> <span class="va">pheno</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">TIME</span>, <span class="va">WT</span><span class="op">)</span>
<span class="va">db</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dataTibble.html">dataTibble</a></span><span class="op">(</span>object<span class="op">=</span><span class="va">m1</span>, <span class="va">regimen</span>, <span class="va">observed</span>, <span class="va">covariates</span><span class="op">)</span>

<span class="co">#We will only perform the evaluation for the first 5 subjects, for performance reasons</span>
<span class="va">db</span> <span class="op">&lt;-</span> <span class="va">db</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, <span class="op">]</span>
<span class="va">posthocPrediction</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/posthoc.html">posthoc</a></span><span class="op">(</span><span class="va">db</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">posthocPrediction</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">posthocPrediction</span><span class="op">$</span><span class="va">fit</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, se.fit<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span>
<span class="va">prosevalResults</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/posthoc.html">proseval</a></span><span class="op">(</span><span class="va">db</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">prosevalResults</span><span class="op">)</span>
<span class="va">prosevalResults</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">observed</span>, <span class="va">ipred</span><span class="op">)</span>, names_sep<span class="op">=</span><span class="st">"."</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">OBS</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>INCLUDED <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="op">)</span> <span class="op">&lt;=</span> <span class="va">OBS</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">ipred.TIME</span>, y<span class="op">=</span><span class="va">ipred.CONC</span> <span class="op">-</span> <span class="va">observed.CONC</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>se<span class="op">=</span><span class="cn">F</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="fl">0</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.96</span>, <span class="fl">1.96</span><span class="op">)</span><span class="op">*</span><span class="va">m1</span><span class="op">$</span><span class="va">res_var</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">sigma</span><span class="op">(</span><span class="op">)</span>, linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color<span class="op">=</span><span class="va">INCLUDED</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">999</span>, by<span class="op">=</span><span class="fl">24</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">OBS</span>, labeller<span class="op">=</span><span class="va">label_both</span><span class="op">)</span>
<span class="co">## We need to add some metadata to the model to easily optimize</span>
<span class="va">m2</span> <span class="op">&lt;-</span> <span class="va">m1</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/metadata.html">metadata</a></span><span class="op">(</span><span class="fu"><a href="../reference/formulation.html">formulation</a></span><span class="op">(</span><span class="st">"Default"</span>, <span class="st">"mg"</span>, dosing_interval<span class="op">=</span><span class="fl">24</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/metadata.html">metadata</a></span><span class="op">(</span><span class="fu"><a href="../reference/target.html">target</a></span><span class="op">(</span>min<span class="op">=</span><span class="fl">30</span>, max<span class="op">=</span><span class="fl">30</span><span class="op">)</span><span class="op">)</span>

<span class="co">## The modified simulation database:</span>
<span class="co">## keep ID, fit, and covariates</span>
<span class="co">## the fit is used as the "truth" to predict new concentrations</span>
<span class="co">## the new regimen assumes a default 24h-based administration</span>
<span class="va">simulationDb</span> <span class="op">&lt;-</span> <span class="va">posthocPrediction</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">fit</span>, <span class="va">covariates</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>regimen<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>TIME<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">140</span>, by<span class="op">=</span><span class="fl">24</span><span class="op">)</span>, AMT<span class="op">=</span><span class="cn">NA</span>, FORM<span class="op">=</span><span class="st">"Default"</span><span class="op">)</span><span class="op">)</span>,
         object<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span><span class="op">)</span> 

<span class="co">## Adjustment option 1: measure at each trough</span>
<span class="va">measureAtTrough</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fit</span>, <span class="va">regimen</span>, <span class="va">truth</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">observed</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findDose.html">findDoses</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nextTime<span class="op">=</span><span class="va">regimen</span><span class="op">$</span><span class="va">TIME</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="fl">0.01</span>, regimen<span class="op">=</span><span class="va">rec</span><span class="op">$</span><span class="va">regimen</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">now</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">observed</span><span class="op">$</span><span class="va">TIME</span><span class="op">)</span> <span class="op">+</span> <span class="fl">3</span>
    <span class="va">regimen</span><span class="op">$</span><span class="va">FIX</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="op">(</span><span class="va">regimen</span><span class="op">$</span><span class="va">TIME</span> <span class="op">&gt;</span> <span class="va">now</span><span class="op">)</span>
    <span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findDose.html">findDoses</a></span><span class="op">(</span><span class="va">fit</span>, regimen<span class="op">=</span><span class="va">regimen</span><span class="op">)</span>
    <span class="va">nextTime</span> <span class="op">&lt;-</span> <span class="va">regimen</span><span class="op">$</span><span class="va">TIME</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="va">regimen</span><span class="op">$</span><span class="va">FIX</span><span class="op">)</span><span class="op">]</span> <span class="co">#next trough</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nextTime<span class="op">=</span><span class="va">nextTime</span><span class="op">-</span><span class="fl">0.01</span>, regimen<span class="op">=</span><span class="va">rec</span><span class="op">$</span><span class="va">regimen</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="co">## Adjustment option 2: measure 8h before trough, so you can still adapt</span>
<span class="va">measure8hBeforeTrough</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fit</span>, <span class="va">regimen</span>, <span class="va">truth</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">observed</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findDose.html">findDoses</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nextTime<span class="op">=</span><span class="va">regimen</span><span class="op">$</span><span class="va">TIME</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">-</span><span class="fl">8</span>, regimen<span class="op">=</span><span class="va">rec</span><span class="op">$</span><span class="va">regimen</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">now</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">observed</span><span class="op">$</span><span class="va">TIME</span><span class="op">)</span> <span class="op">+</span> <span class="fl">3</span>
    <span class="va">regimen</span><span class="op">$</span><span class="va">FIX</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="op">(</span><span class="va">regimen</span><span class="op">$</span><span class="va">TIME</span> <span class="op">&gt;</span> <span class="va">now</span><span class="op">)</span>
    <span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findDose.html">findDoses</a></span><span class="op">(</span><span class="va">fit</span>, regimen<span class="op">=</span><span class="va">regimen</span><span class="op">)</span>
    <span class="va">nextTime</span> <span class="op">&lt;-</span> <span class="va">regimen</span><span class="op">$</span><span class="va">TIME</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="va">regimen</span><span class="op">$</span><span class="va">FIX</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="co">#next trough</span>
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nextTime<span class="op">=</span><span class="va">nextTime</span><span class="op">-</span><span class="fl">8</span>, regimen<span class="op">=</span><span class="va">rec</span><span class="op">$</span><span class="va">regimen</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="co">## Adjustment option 3: rich profile at the beginning</span>
<span class="va">richProfileAtBeginning</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">fit</span>, <span class="va">regimen</span>, <span class="va">truth</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">richProfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">4</span>, <span class="fl">6</span>, <span class="fl">8</span>, <span class="fl">10</span><span class="op">)</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">observed</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findDose.html">findDoses</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nextTime<span class="op">=</span><span class="va">richProfile</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, regimen<span class="op">=</span><span class="va">rec</span><span class="op">$</span><span class="va">regimen</span><span class="op">)</span> <span class="op">)</span>
  <span class="op">}</span>
  
  <span class="va">nextTime</span> <span class="op">&lt;-</span> <span class="va">richProfile</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">observed</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span><span class="op">]</span>
  <span class="va">regimen</span><span class="op">$</span><span class="va">FIX</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>
  <span class="va">regimen</span><span class="op">$</span><span class="va">FIX</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span> <span class="co">#loading dose cannot be changed</span>
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">fit</span><span class="op">$</span><span class="va">observed</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">richProfile</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">rec</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findDose.html">findDoses</a></span><span class="op">(</span><span class="va">fit</span>, regimen<span class="op">=</span><span class="va">regimen</span><span class="op">)</span>
    <span class="va">regimen</span> <span class="op">&lt;-</span> <span class="va">rec</span><span class="op">$</span><span class="va">regimen</span>
  <span class="op">}</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nextTime<span class="op">=</span><span class="va">nextTime</span>, regimen<span class="op">=</span><span class="va">regimen</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">simulationResult</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findDose.html">doseSimulation</a></span><span class="op">(</span><span class="va">simulationDb</span>, optimize<span class="op">=</span><span class="va">measureAtTrough</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>method<span class="op">=</span><span class="st">"A. At Trough"</span><span class="op">)</span>
<span class="va">simulationResult2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findDose.html">doseSimulation</a></span><span class="op">(</span><span class="va">simulationDb</span>, optimize<span class="op">=</span><span class="va">measure8hBeforeTrough</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>method<span class="op">=</span><span class="st">"B. 8h before trough"</span><span class="op">)</span>
<span class="va">simulationResult3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/findDose.html">doseSimulation</a></span><span class="op">(</span><span class="va">simulationDb</span>, optimize<span class="op">=</span><span class="va">richProfileAtBeginning</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>method<span class="op">=</span><span class="st">"C. Rich profile"</span><span class="op">)</span>

<span class="va">fullResult</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">simulationResult</span>, <span class="va">simulationResult2</span>, <span class="va">simulationResult3</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">ID</span>, <span class="va">method</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co">#only keep the last regimen</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ipred <span class="op">=</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map2.html">map2</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">next_regimen</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">.x</span>, regimen<span class="op">=</span><span class="va">.y</span>, newdata<span class="op">=</span><span class="fl">0</span><span class="op">:</span><span class="fl">144</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">fullResult</span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">fullResult</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">TIME</span>, y<span class="op">=</span><span class="va">CONC</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">.</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols<span class="op">=</span><span class="va">ipred</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>group<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/interaction.html">interaction</a></span><span class="op">(</span><span class="va">method</span>,<span class="va">ID</span><span class="op">)</span>, color<span class="op">=</span><span class="va">method</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">.</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span><span class="op">(</span>cols<span class="op">=</span><span class="va">observed</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="fl">30</span>, linetype<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_hline</a></span><span class="op">(</span>yintercept<span class="op">=</span><span class="fl">30</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.96</span>, <span class="op">-</span><span class="fl">1.96</span><span class="op">)</span><span class="op">*</span><span class="va">m1</span><span class="op">$</span><span class="va">res_var</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">add</span>, linetype<span class="op">=</span><span class="fl">2</span>, alpha<span class="op">=</span><span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position<span class="op">=</span><span class="st">"none"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">method</span><span class="op">)</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Ruben Faelens, Nicolas Luyckx, Quentin Leirens, FWO TBM Grant.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
