---
title: "Multiple endpoints in TDMore"
date: "`r Sys.Date()`"
output:
  html_document:
    keep_md: true
vignette: >
  %\VignetteIndexEntry{Multiple endpoints in TDMore}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
![TDMore logo](static/tdmore_logo.JPG)

# Writing and testing the PK model

In this vignette, we will learn how TDMore can deal with multiple endpoints. The PK/PD models chosen to illustrate this section are based on the following paper: "Population PK/PD modeling of Sunitinib by dosing schedule in patients with advanced renal cell carcinoma or gastrointestinal stromal tumor.". PDF file is available here. Let's start writing the Sunitinib PK model.  
  
```{r, echo=FALSE}
set.seed(0) 
```

```{r}
library(nlmixr)

modelCode <- function(){
  ini({
    TVCL <- 34.1
    TVVc <- 2700
    TVKa <- 0.126
    TVVp <- 774
    TVQ <- 0.688

    ECL ~ 0.060516 # 24.6%
    EVc ~ 0.052900 # 23.0%
    EKa ~ 2.755600 # 166%

    EPS_Prop <- 0.417
  })
  model({
    CL <- TVCL * exp(ECL)
    Vc <- TVVc * exp(EVc)
    Vp <- TVVp
    Q <- TVQ
    K12 <- Q/Vc
    K21 <- Q/Vp
    Ke <- CL/Vc
    Ka <- TVKa*exp(EKa)

    d/dt(depot) = -Ka*depot
    d/dt(center) = Ka*depot - Ke*center - K12*center + K21*periph
    d/dt(periph) = K12*center - K21*periph

    CONC = center/Vc
    CONC ~ prop(EPS_Prop)
  })
}

```

The TDMore object is instantiated as follows:

```{r, message=FALSE, results='hide'}
library(tdmore)

nlmixrUI <- nlmixrUI(modelCode)
tdmore <- tdmore(nlmixrUI)
```

A basic regimen can be created to test that the model is properly running. 50 mg Sunitinib is given for a week.

```{r}
regimen <- data.frame(
  TIME=0,   # First dose time: t=0h
  AMT=50,   # Dose amount: 50 mg
  II=24,    # Dose interval: 24h
  ADDL=7  # Additional doses: 7
)

times <- seq(0, 1*7*24, by=1) # Observation times
```

This regimen can be plotted using the default TDMore plotting function. It shows the typical value of the population and the between-subject variability (95% confidence interval).

```{r sunitinib_pk_model, fig.align='center', fig.height = 3, fig.width = 8}
plot(tdmore, regimen, newdata=times)
```

# Adding a PD model

Many different PD models are described in the paper mentionned above. We will focus on the simplest one: a PD model related to the target tumor's sum of the longest diameters (abbreviated SLD), which corresponds to the main efficacy endpoint of Sunitinib. Adding this PD model to the existing PK model is done as follows. Please note the mandatory '|' nlmixr syntax used to describe the residual variability of both endpoints (CONC and SLD).

```{r, message=FALSE, results='hide'}
modelCode <- function(){
  ini({
    # PK model sunitinib
    TVCL <- 34.1
    TVVc <- 2700
    TVKa <- 0.126
    TVVp <- 774
    TVQ <- 0.688

    ECL ~ 0.060516 # 24.6%
    EVc ~ 0.052900 # 23.0%
    EKa ~ 2.755600 # 166%

    EPS_Prop <- 0.417 # Proportional error 1 (related to CONC)

    # PD model SLD (Tumor sum of longest diameters)
    TVBASE <- 14.3 #cm
    TVKout <- 0.000267
    TVEMax <- 1
    TVEC50 <- 30.5
    TVKtol <- 0.0000141

    EBASE ~ 0.840889 # 91.7%
    EKout ~ 0.521284 # 72.2%
    EEC50 ~ 3.312400 # 182%
    EKtol ~ 0.720801 # 84.9%

    EPS_Prop_SLD <- 0.143 # Proportional error 2 (related to SLD)
  })
  model({
    CL <- TVCL * exp(ECL)
    Vc <- TVVc * exp(EVc)
    Vp <- TVVp
    Q <- TVQ
    K12 <- Q/Vc
    K21 <- Q/Vp
    Ke <- CL/Vc
    Ka <- TVKa*exp(EKa)
    BASE <- TVBASE * exp(EBASE)
    Kout <- TVKout * exp(EKout)
    EMax <- TVEMax
    EC50 <- TVEC50 * exp(EEC50)
    Ktol <- TVKtol * exp(EKtol)
    Kin <- Kout*BASE

    d/dt(depot) = -Ka*depot
    d/dt(center) = Ka*depot - Ke*center - K12*center + K21*periph
    d/dt(periph) = K12*center - K21*periph
    DRUG = EMax*(center/Vc) / (EC50 + center/Vc)
    d/dt(SLD) = Kin*(1-DRUG) - Kout*SLD*(1+exp(-Ktol*t)) # PD model ode

    CONC = center/Vc
    CONC ~ prop(EPS_Prop) | center # Define error model 1

    SLD(0) = BASE                  # Set SLD initial value at time t=0
    SLD ~ prop(EPS_Prop_SLD) | SLD # Define error model 2
  })
}
nlmixrUI <- nlmixrUI(modelCode)
tdmore <- tdmore(nlmixrUI, maxsteps=1E3*500) # Old tdmore object is overridden
```

Let's now have a look at the evolution of SLD over time. To have a good overview, we'll observe SLD for 40 weeks. The default plot shows once again the typical value and the between-subject variability (95% CI).

```{r sunitinib_pd_model, fig.align='center', fig.height = 3, fig.width = 8}
regimen <- data.frame(
  TIME=0,
  AMT=50,
  II=24,
  ADDL=40*7
)
times <- seq(0, 40*7*24, by=1)

# Note that 'SLD' is specified in the newdata dataframe to select the right endpoint
# If not specified, both endpoints are printed
plot(tdmore, regimen, newdata=data.frame(TIME=times, SLD=NA))
```

# Estimating individual parameters

Assume SLD is measured at week 0 and week 30 for a certain individual. Model parameters can be estimated and visualised as follows:
```{r sunitinib_pd_ipred_sld, fig.align='center', fig.height = 3, fig.width = 8}
observed <- data.frame(TIME=c(0, 30*7*24), CONC=NA, SLD=c(25, 14))
ipred <- estimate(tdmore = tdmore, observed = observed, regimen = regimen)
plot(ipred, newdata=data.frame(TIME=times, SLD=NA))
```

Coefficients show that the PD model could be estimated correctly. 
```{r}
coef(ipred)
vcov(ipred)
```

However, TDMore is not able to estimated PK parameters because no data was provided, as confirmed by the following plot (IPRED strictly equal to PRED, only the last week is shown).

```{r sunitinib_pd_ipred_conc, fig.align='center', fig.height = 3, fig.width = 8}
plot(ipred, newdata=data.frame(TIME=seq(29*7*24, 30*7*24, by=1), CONC=NA), se.fit=F)
```
