<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prospective evaluation • tdmore</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Prospective evaluation">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tdmore</a>
        <span class="version label label-warning" data-toggle="tooltip" data-placement="bottom" title="Parameter estimation is stable, but dose recommendation API is subject to change">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/tdmore.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/dosing-regimen.html">Simulating different dosing regimen</a>
    </li>
    <li>
      <a href="../articles/ggplot.html">Using ggplot to visualize tdmore results</a>
    </li>
    <li>
      <a href="../articles/proseval.html">Prospective evaluation</a>
    </li>
    <li>
      <a href="../articles/tdmore_multiple_endpoints.html">Multiple endpoints in TDMore</a>
    </li>
    <li>
      <a href="../articles/testing_adherence.html">Testing adherence using TDMore</a>
    </li>
  </ul>
</li>
<li>
  <a href="../book/index.html">
    <span class="fa fa-book"></span>
     
    Book
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/tdmore-dev/tdmore">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Prospective evaluation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tdmore-dev/tdmore/blob/master/vignettes/proseval.Rmd"><code>vignettes/proseval.Rmd</code></a></small>
      <div class="hidden name"><code>proseval.Rmd</code></div>

    </div>

    
    
<div id="about-this-example" class="section level3 unnumbered">
<h3 class="hasAnchor">
<a href="#about-this-example" class="anchor"></a>About this example</h3>
<p>Qualification of non-linear mixed effects models for population PK/PD is a well-studied problem. We can evaluate goodness-of-fit through several standard metrics like LL, AIC, by evaluating a visual predictive check or even evaluating key prediction metrics through a numerical predictive check.</p>
<p>Evaluating how well a model predicts the future for a specific individual is less well-studied. We have settled on using ‘prospective evaluation’. This technique splits the individual data in a training and validation dataset: anything before a given timepoint <code>t_i</code> is used to calculate the individual fit, anything after <code>t_i</code> is used to evaluate how well this fit predicts the future. By repeating this exercise for every possible <code>t_i</code>, we can evaluate how well we predict the future at day 1, day 2, etc.</p>
<p>This vignette shows how to use <code>tdmore</code> in such an evaluation. This is also called a <em>prospective evaluation</em>, and has been (rudimentarily) implemented in the <a href="https://github.com/UUPharmacometrics/PsN/releases/download/4.9.0/proseval_userguide.pdf" title="proseval manual page">PsN proseval</a> routine.</p>
<pre><code>## 
## Attaching package: 'dplyr'</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union</code></pre>
<pre><code>## 
## Attaching package: 'purrr'</code></pre>
<pre><code>## The following object is masked from 'package:tdmore':
## 
##     flatten</code></pre>
</div>
<div id="example-model" class="section level3">
<h3 class="hasAnchor">
<a href="#example-model" class="anchor"></a>Example model</h3>
<p>We use an example model from literature.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="co"># Model taken from literature: Soulele, K., et al.</span></a>
<a class="sourceLine" id="cb6-2" title="2"><span class="co"># 'Population pharmacokinetics of fluticasone propionate/salmeterol using two different dry powder inhalers.'</span></a>
<a class="sourceLine" id="cb6-3" title="3"><span class="co"># European Journal of Pharmaceutical Sciences 80 (2015): 33-42."</span></a>
<a class="sourceLine" id="cb6-4" title="4">myModel &lt;-<span class="st"> </span>nlmixr<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/nlmixr/topics/nlmixrUI">nlmixrUI</a></span>(<span class="cf">function</span>(){</a>
<a class="sourceLine" id="cb6-5" title="5">  <span class="kw">ini</span>({</a>
<a class="sourceLine" id="cb6-6" title="6">    TVKa &lt;-<span class="st"> </span><span class="fl">3.87</span></a>
<a class="sourceLine" id="cb6-7" title="7">    TVCL &lt;-<span class="st"> </span><span class="dv">659</span>    <span class="co"># L/h</span></a>
<a class="sourceLine" id="cb6-8" title="8">    TVV1 &lt;-<span class="st"> </span><span class="dv">56900</span>  <span class="co"># L</span></a>
<a class="sourceLine" id="cb6-9" title="9">    TVV2 &lt;-<span class="st"> </span><span class="dv">5550</span>   <span class="co"># L</span></a>
<a class="sourceLine" id="cb6-10" title="10">    TVQ &lt;-<span class="st"> </span><span class="dv">259</span>     <span class="co"># L/h</span></a>
<a class="sourceLine" id="cb6-11" title="11"></a>
<a class="sourceLine" id="cb6-12" title="12">    EKa <span class="op">~</span><span class="st"> </span><span class="fl">0.04507129</span>  <span class="co"># 0.2123**2</span></a>
<a class="sourceLine" id="cb6-13" title="13">    ECL <span class="op">~</span><span class="st"> </span><span class="fl">0.1535856</span>   <span class="co"># 0.3919**2</span></a>
<a class="sourceLine" id="cb6-14" title="14">    EV1 <span class="op">~</span><span class="st"> </span><span class="fl">0.09223369</span>  <span class="co"># 0.3037**2</span></a>
<a class="sourceLine" id="cb6-15" title="15">    EV2 <span class="op">~</span><span class="st"> </span><span class="fl">0.208301</span>    <span class="co"># 0.4564**2</span></a>
<a class="sourceLine" id="cb6-16" title="16">    EQ <span class="op">~</span><span class="st"> </span><span class="fl">0.1015697</span>    <span class="co"># 0.3187**2</span></a>
<a class="sourceLine" id="cb6-17" title="17"></a>
<a class="sourceLine" id="cb6-18" title="18">    EPS_ADD &lt;-<span class="st"> </span><span class="fl">1.91</span></a>
<a class="sourceLine" id="cb6-19" title="19">    EPS_PROP &lt;-<span class="st"> </span><span class="fl">0.117</span></a>
<a class="sourceLine" id="cb6-20" title="20">  })</a>
<a class="sourceLine" id="cb6-21" title="21">  <span class="kw">model</span>({</a>
<a class="sourceLine" id="cb6-22" title="22">    Ka &lt;-<span class="st"> </span>TVKa <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(EKa)</a>
<a class="sourceLine" id="cb6-23" title="23">    CL &lt;-<span class="st"> </span>TVCL <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(ECL)</a>
<a class="sourceLine" id="cb6-24" title="24">    V1 &lt;-<span class="st"> </span>TVV1 <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(EV1)</a>
<a class="sourceLine" id="cb6-25" title="25">    V2 &lt;-<span class="st"> </span>TVV2 <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(EV2)</a>
<a class="sourceLine" id="cb6-26" title="26">    Q &lt;-<span class="st"> </span>TVQ <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(EQ)</a>
<a class="sourceLine" id="cb6-27" title="27">    </a>
<a class="sourceLine" id="cb6-28" title="28">    K12 &lt;-<span class="st"> </span>Q<span class="op">/</span>V1</a>
<a class="sourceLine" id="cb6-29" title="29">    K21 &lt;-<span class="st"> </span>Q<span class="op">/</span>V2</a>
<a class="sourceLine" id="cb6-30" title="30"></a>
<a class="sourceLine" id="cb6-31" title="31">    d<span class="op">/</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/TDist">dt</a></span>(center) =<span class="st"> </span><span class="op">-</span><span class="st"> </span>CL<span class="op">/</span>V1 <span class="op">*</span><span class="st"> </span>center <span class="op">-</span><span class="st"> </span>K12<span class="op">*</span>center <span class="op">+</span><span class="st"> </span>K21 <span class="op">*</span><span class="st"> </span>periph</a>
<a class="sourceLine" id="cb6-32" title="32">    d<span class="op">/</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/TDist">dt</a></span>(periph) =<span class="st"> </span>K12<span class="op">*</span>center <span class="op">-</span><span class="st"> </span>K21 <span class="op">*</span><span class="st"> </span>periph</a>
<a class="sourceLine" id="cb6-33" title="33"></a>
<a class="sourceLine" id="cb6-34" title="34">    CONC =<span class="st"> </span>center <span class="op">/</span><span class="st"> </span>V1 <span class="op">*</span><span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb6-35" title="35">    CONC <span class="op">~</span><span class="st"> </span><span class="kw">prop</span>(EPS_PROP) <span class="op">+</span><span class="st"> </span><span class="kw">add</span>(EPS_ADD)</a>
<a class="sourceLine" id="cb6-36" title="36">  })</a>
<a class="sourceLine" id="cb6-37" title="37">})</a>
<a class="sourceLine" id="cb6-38" title="38"></a>
<a class="sourceLine" id="cb6-39" title="39">m1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tdmore.html">tdmore</a></span>(myModel)</a></code></pre></div>
</div>
<div id="source-data-in-silico-simulation" class="section level3">
<h3 class="hasAnchor">
<a href="#source-data-in-silico-simulation" class="anchor"></a>Source data: in silico simulation</h3>
<p>Without a source dataset, we can generate data from an in silico simulation. Below, we use the standard treatment regimen of 88mcg twice-daily, with blood samples every week.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">regimen &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(</a>
<a class="sourceLine" id="cb7-2" title="2">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">TIME=</span><span class="dv">0</span>, <span class="dt">AMT=</span><span class="dv">500</span>), <span class="co">#loading dose</span></a>
<a class="sourceLine" id="cb7-3" title="3">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>( <span class="co">#maintenance dose</span></a>
<a class="sourceLine" id="cb7-4" title="4">    <span class="dt">TIME=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sort">sort</a></span>( <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">8</span><span class="op">+</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">20</span>)<span class="op">*</span><span class="dv">24</span>, <span class="dv">20</span><span class="op">+</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">20</span>)<span class="op">*</span><span class="dv">24</span>) ), <span class="co">#at 08:00 and 20:00</span></a>
<a class="sourceLine" id="cb7-5" title="5">    <span class="dt">AMT=</span><span class="dv">88</span></a>
<a class="sourceLine" id="cb7-6" title="6">  )</a>
<a class="sourceLine" id="cb7-7" title="7">)</a>
<a class="sourceLine" id="cb7-8" title="8">obs &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(</a>
<a class="sourceLine" id="cb7-9" title="9">  <span class="dt">TIME=</span>(<span class="dv">3</span><span class="op">*</span><span class="dv">24</span><span class="op">+</span><span class="dv">12</span>)<span class="op">+</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">2</span>)<span class="op">*</span><span class="dv">7</span><span class="op">*</span><span class="dv">24</span>, <span class="co">#observe every 3rd day of the week at noon</span></a>
<a class="sourceLine" id="cb7-10" title="10">  <span class="dt">CONC=</span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb7-11" title="11">)</a>
<a class="sourceLine" id="cb7-12" title="12"></a>
<a class="sourceLine" id="cb7-13" title="13"><span class="co"># predict generates N samples of a tdmorefit with uncertainty</span></a>
<a class="sourceLine" id="cb7-14" title="14"><span class="co"># If we use the population fit, then this will represent a sample across the population.</span></a>
<a class="sourceLine" id="cb7-15" title="15"><span class="co"># I.e. N virtual patients</span></a>
<a class="sourceLine" id="cb7-16" title="16"><span class="co"># In a model with covariates, you should either sample the covariates from an external database,</span></a>
<a class="sourceLine" id="cb7-17" title="17"><span class="co"># or generate them from a distribution.</span></a>
<a class="sourceLine" id="cb7-18" title="18">N &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb7-19" title="19">population &lt;-<span class="st"> </span><span class="kw"><a href="../reference/estimate.html">estimate</a></span>(m1, <span class="dt">regimen=</span>regimen)</a>
<a class="sourceLine" id="cb7-20" title="20">dbPred &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(population, <span class="dt">newdata=</span>obs, <span class="dt">se=</span>T, <span class="dt">level=</span><span class="ot">NA</span>, <span class="dt">mc.maxpts=</span>N) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-21" title="21"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">ID=</span>sample) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-22" title="22"><span class="st">  </span><span class="kw">select</span>(ID, TIME, CONC)</a>
<a class="sourceLine" id="cb7-23" title="23"><span class="co"># We add residual error by sampling from the original model</span></a>
<a class="sourceLine" id="cb7-24" title="24"><span class="co"># This is probably too pessimistic; residual error is rarely truly random...</span></a>
<a class="sourceLine" id="cb7-25" title="25">db &lt;-<span class="st"> </span>dbPred <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-26" title="26"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/model.frame">model.frame</a></span>(m1, <span class="dt">data=</span>., <span class="dt">se=</span><span class="ot">TRUE</span>, <span class="dt">level=</span><span class="ot">NA</span>) <span class="co">#sample residual error</span></a>
<a class="sourceLine" id="cb7-27" title="27"></a>
<a class="sourceLine" id="cb7-28" title="28"><span class="kw">ggplot</span>(dbPred, <span class="kw">aes</span>(<span class="dt">x=</span>TIME, <span class="dt">y=</span>CONC)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-29" title="29"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">alpha=</span><span class="fl">0.3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb7-30" title="30"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group=</span>ID), <span class="dt">data=</span>db) <span class="op">+</span></a>
<a class="sourceLine" id="cb7-31" title="31"><span class="st">  </span><span class="kw">geom_smooth</span>()</a></code></pre></div>
<pre><code>## `geom_smooth()` using method = 'loess' and formula 'y ~ x'</code></pre>
<pre><code>## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : pseudoinverse used at 82.32</code></pre>
<pre><code>## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : neighborhood radius 337.68</code></pre>
<pre><code>## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : reciprocal condition number 1.2153e-016</code></pre>
<pre><code>## Warning in simpleLoess(y, x, w, span, degree = degree, parametric =
## parametric, : There are other near singularities as well. 1.1403e+005</code></pre>
<pre><code>## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : pseudoinverse used
## at 82.32</code></pre>
<pre><code>## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : neighborhood radius
## 337.68</code></pre>
<pre><code>## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : reciprocal
## condition number 1.2153e-016</code></pre>
<pre><code>## Warning in predLoess(object$y, object$x, newx = if
## (is.null(newdata)) object$x else if (is.data.frame(newdata))
## as.matrix(model.frame(delete.response(terms(object)), : There are other
## near singularities as well. 1.1403e+005</code></pre>
<p><img src="proseval_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1">posthocFit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/posthoc.html">posthoc</a></span>(m1, <span class="dt">regimen=</span>regimen, <span class="dt">observed=</span>db, <span class="dt">se.fit=</span>F, <span class="dt">control=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">factr=</span><span class="fl">1e14</span>))</a>
<a class="sourceLine" id="cb17-2" title="2">posthocFit <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-3" title="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">coef =</span> <span class="kw">map</span>(fit, <span class="op">~</span>tibble<span class="op">::</span><span class="kw"><a href="https://tibble.tidyverse.org/reference/enframe.html">enframe</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/coef">coef</a></span>(.x)))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-4" title="4"><span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span>(coef) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb17-5" title="5"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>ID, <span class="dt">y=</span>value)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-6" title="6"><span class="st">    </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb17-7" title="7"><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span>name) <span class="op">+</span></a>
<a class="sourceLine" id="cb17-8" title="8"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">"Eta estimates for posthoc fit"</span>)</a></code></pre></div>
<p><img src="proseval_files/figure-html/unnamed-chunk-3-2.png" width="700"></p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1"><span class="kw">ggplot</span>(db, <span class="kw">aes</span>(<span class="dt">x=</span>TIME, <span class="dt">y=</span>CONC)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-2" title="2"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb18-3" title="3"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data=</span> posthocFit <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">ipred =</span> <span class="kw">map</span>(fit, predict)) <span class="op">%&gt;%</span><span class="st"> </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span>(ipred) ) <span class="op">+</span></a>
<a class="sourceLine" id="cb18-4" title="4"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>ID) <span class="op">+</span></a>
<a class="sourceLine" id="cb18-5" title="5"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">"Individual fits using all available data"</span>)</a></code></pre></div>
<p><img src="proseval_files/figure-html/unnamed-chunk-3-3.png" width="700"></p>
</div>
<div id="source-data-retrospective-data" class="section level3">
<h3 class="hasAnchor">
<a href="#source-data-retrospective-data" class="anchor"></a>Source data: retrospective data</h3>
<p>A retrospective dataset can also be used. Aggregating this data across individuals may be difficult if there are large differences in treatment, observation schedule or adherence. Furthermore, a decision should be made up-front on how to treat missing values.</p>
<p>As an example: If we evaluate how well we predict day3 using day 1+2 data, should we…</p>
<ol style="list-style-type: lower-alpha">
<li>discard patients with missing data on day3 (target), as there is no point of reference in this case?</li>
<li>discard patients with missing data on day1 or day2, as there is less data to calculate an accurate fit?</li>
</ol>
<p>This can be solved by using all data to generate an individual fit, and predicting (interpolating) missing data.</p>
</div>
<div id="calculating-prospective-evaluation" class="section level3 unnumbered">
<h3 class="hasAnchor">
<a href="#calculating-prospective-evaluation" class="anchor"></a>Calculating prospective evaluation</h3>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1"><span class="co">## Input data: 'm1', the tdmore model</span></a>
<a class="sourceLine" id="cb19-2" title="2"><span class="co">## Input data: 'db' with columns ID, TIME and CONC</span></a>
<a class="sourceLine" id="cb19-3" title="3"><span class="co">## Input data: 'regimen' with columns TIME and AMT.</span></a>
<a class="sourceLine" id="cb19-4" title="4"><span class="co">## Note that with true retrospective data, the regimen would be different per individual</span></a>
<a class="sourceLine" id="cb19-5" title="5">prosevalDb &lt;-<span class="st"> </span><span class="kw"><a href="../reference/proseval.html">proseval</a></span>(m1, <span class="dt">regimen=</span>regimen, <span class="dt">observed=</span>db, <span class="dt">control=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">factr=</span><span class="fl">1e14</span>))</a></code></pre></div>
</div>
<div id="graphical-representation" class="section level3 unnumbered">
<h3 class="hasAnchor">
<a href="#graphical-representation" class="anchor"></a>Graphical representation</h3>
<p>We now have a list of prospective evaluations for every subject. Suppose we want to use the model to modify the dose for next week. In that case, we want to check how well a prospective evaluation predicts next week.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1"><span class="co"># Calculate predictions for all data, using the fits</span></a>
<a class="sourceLine" id="cb20-2" title="2">prosevalPred &lt;-<span class="st"> </span>prosevalDb <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-3" title="3"><span class="st">  </span><span class="kw">left_join</span>(db <span class="op">%&gt;%</span><span class="st"> </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span>(<span class="op">-</span>ID), <span class="dt">by=</span><span class="st">"ID"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-4" title="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ipred =</span> <span class="kw">pmap</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(fit, <span class="dt">newdata=</span>data), predict) )</a>
<a class="sourceLine" id="cb20-5" title="5"></a>
<a class="sourceLine" id="cb20-6" title="6">target &lt;-<span class="st"> </span>prosevalPred <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-7" title="7"><span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span>(data, ipred, <span class="dt">.sep=</span><span class="st">"."</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb20-8" title="8"><span class="st">  </span><span class="kw">group_by</span>(ID, OBS) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb20-9" title="9"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(<span class="kw">row_number</span>() <span class="op">==</span><span class="st"> </span>OBS[<span class="dv">1</span>]<span class="op">+</span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st">  </span><span class="co">#pick the next week as a target</span></a>
<a class="sourceLine" id="cb20-10" title="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">IRES =</span> data.CONC<span class="op">-</span>ipred.CONC)</a>
<a class="sourceLine" id="cb20-11" title="11"></a>
<a class="sourceLine" id="cb20-12" title="12"><span class="kw">ggplot</span>(target, <span class="kw">aes</span>(<span class="dt">x=</span>IRES)) <span class="op">+</span></a>
<a class="sourceLine" id="cb20-13" title="13"><span class="st">  </span><span class="kw">stat_ecdf</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb20-14" title="14"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept=</span><span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb20-15" title="15"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>OBS) <span class="op">+</span></a>
<a class="sourceLine" id="cb20-16" title="16"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">"Absolute prediction error on day i+1</span><span class="ch">\n</span><span class="st">Using on all data available on day i"</span>)</a></code></pre></div>
<p><img src="proseval_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1">parameters &lt;-<span class="st"> </span>prosevalDb <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-2" title="2"><span class="st">  </span><span class="kw">group_by</span>(ID, OBS) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-3" title="3"><span class="st">  </span><span class="kw">group_modify</span>(<span class="op">~</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(.x<span class="op">$</span>fit[[<span class="dv">1</span>]], <span class="dt">newdata=</span><span class="dv">0</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-4" title="4"><span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span>(<span class="dt">key=</span>key, <span class="dt">value=</span>value, Ka<span class="op">:</span>V2) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-5" title="5"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">relative=</span>value <span class="op">/</span><span class="st"> </span>value[<span class="dv">1</span>] )</a>
<a class="sourceLine" id="cb21-6" title="6">parameters <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb21-7" title="7"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>OBS, <span class="dt">y=</span>relative<span class="op">*</span><span class="dv">100</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb21-8" title="8"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>key, <span class="dt">scales=</span><span class="st">"free"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb21-9" title="9"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb21-10" title="10"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group=</span>ID)) <span class="op">+</span></a>
<a class="sourceLine" id="cb21-11" title="11"><span class="st">  </span><span class="kw">scale_y_log10</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb21-12" title="12"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">"Evolution of parameter values over time"</span>,</a>
<a class="sourceLine" id="cb21-13" title="13">       <span class="dt">y=</span><span class="st">"Relative change (%)"</span>)</a></code></pre></div>
<p><img src="proseval_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
</div>
<div id="how-does-this-impact-dose-adaptation" class="section level3 unnumbered">
<h3 class="hasAnchor">
<a href="#how-does-this-impact-dose-adaptation" class="anchor"></a>How does this impact dose adaptation?</h3>
<p>The better a model can predict the future, the more accurate it can calculate the dose to reach a given target. A rough indication for “% on target” is to calculate <code>IPRED / DV</code>. If this is higher than 1, then the model is overpredicting (and will underdose). If this is lower than 1, the model is underpredicting (and will overdose). Assuming your target window is e.g. between 10 and 15, the log-mean is <code><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp( mean( log(c(10,15)) ) )</a></code> and the relative error should be between <code>0.81</code> and <code>1.22</code>.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1"><span class="kw">ggplot</span>(target, <span class="kw">aes</span>(<span class="dt">x=</span>ipred.CONC <span class="op">/</span><span class="st"> </span>data.CONC)) <span class="op">+</span></a>
<a class="sourceLine" id="cb22-2" title="2"><span class="st">  </span><span class="kw">stat_ecdf</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb22-3" title="3"><span class="st">  </span><span class="kw">scale_x_log10</span>(<span class="dt">limits=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.5</span>, <span class="dv">2</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb22-4" title="4"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept=</span><span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb22-5" title="5"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.81</span>, <span class="fl">1.22</span>), <span class="dt">linetype=</span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb22-6" title="6"><span class="st">  </span><span class="kw">geom_label</span>(<span class="kw">aes</span>(<span class="dt">x=</span><span class="fl">1.8</span>, <span class="dt">y=</span><span class="fl">0.5</span>, <span class="dt">label=</span>label), <span class="dt">data=</span>. <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(OBS) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">label=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>( <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">round</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(<span class="kw">between</span>(ipred.CONC<span class="op">/</span>data.CONC, <span class="fl">0.81</span>, <span class="fl">1.22</span>))<span class="op">*</span><span class="dv">100</span>), <span class="st">"%"</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb22-7" title="7"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>OBS) <span class="op">+</span></a>
<a class="sourceLine" id="cb22-8" title="8"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">"Relative prediction error on day i+1</span><span class="ch">\n</span><span class="st">Using on all data available on day i"</span>)</a></code></pre></div>
<pre><code>## Warning: Removed 2 rows containing non-finite values (stat_ecdf).</code></pre>
<p><img src="proseval_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
</div>
<div id="code-appendix" class="section level3">
<h3 class="hasAnchor">
<a href="#code-appendix" class="anchor"></a>Code appendix</h3>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tdmore)</a>
<a class="sourceLine" id="cb24-2" title="2"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)</a>
<a class="sourceLine" id="cb24-3" title="3"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(purrr)</a>
<a class="sourceLine" id="cb24-4" title="4"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyr)</a>
<a class="sourceLine" id="cb24-5" title="5"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)</a>
<a class="sourceLine" id="cb24-6" title="6"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Random">set.seed</a></span>(<span class="dv">1234</span>)</a>
<a class="sourceLine" id="cb24-7" title="7"></a>
<a class="sourceLine" id="cb24-8" title="8"><span class="co"># Model taken from literature: Soulele, K., et al.</span></a>
<a class="sourceLine" id="cb24-9" title="9"><span class="co"># 'Population pharmacokinetics of fluticasone propionate/salmeterol using two different dry powder inhalers.'</span></a>
<a class="sourceLine" id="cb24-10" title="10"><span class="co"># European Journal of Pharmaceutical Sciences 80 (2015): 33-42."</span></a>
<a class="sourceLine" id="cb24-11" title="11">myModel &lt;-<span class="st"> </span>nlmixr<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/nlmixr/topics/nlmixrUI">nlmixrUI</a></span>(<span class="cf">function</span>(){</a>
<a class="sourceLine" id="cb24-12" title="12">  <span class="kw">ini</span>({</a>
<a class="sourceLine" id="cb24-13" title="13">    TVKa &lt;-<span class="st"> </span><span class="fl">3.87</span></a>
<a class="sourceLine" id="cb24-14" title="14">    TVCL &lt;-<span class="st"> </span><span class="dv">659</span>    <span class="co"># L/h</span></a>
<a class="sourceLine" id="cb24-15" title="15">    TVV1 &lt;-<span class="st"> </span><span class="dv">56900</span>  <span class="co"># L</span></a>
<a class="sourceLine" id="cb24-16" title="16">    TVV2 &lt;-<span class="st"> </span><span class="dv">5550</span>   <span class="co"># L</span></a>
<a class="sourceLine" id="cb24-17" title="17">    TVQ &lt;-<span class="st"> </span><span class="dv">259</span>     <span class="co"># L/h</span></a>
<a class="sourceLine" id="cb24-18" title="18"></a>
<a class="sourceLine" id="cb24-19" title="19">    EKa <span class="op">~</span><span class="st"> </span><span class="fl">0.04507129</span>  <span class="co"># 0.2123**2</span></a>
<a class="sourceLine" id="cb24-20" title="20">    ECL <span class="op">~</span><span class="st"> </span><span class="fl">0.1535856</span>   <span class="co"># 0.3919**2</span></a>
<a class="sourceLine" id="cb24-21" title="21">    EV1 <span class="op">~</span><span class="st"> </span><span class="fl">0.09223369</span>  <span class="co"># 0.3037**2</span></a>
<a class="sourceLine" id="cb24-22" title="22">    EV2 <span class="op">~</span><span class="st"> </span><span class="fl">0.208301</span>    <span class="co"># 0.4564**2</span></a>
<a class="sourceLine" id="cb24-23" title="23">    EQ <span class="op">~</span><span class="st"> </span><span class="fl">0.1015697</span>    <span class="co"># 0.3187**2</span></a>
<a class="sourceLine" id="cb24-24" title="24"></a>
<a class="sourceLine" id="cb24-25" title="25">    EPS_ADD &lt;-<span class="st"> </span><span class="fl">1.91</span></a>
<a class="sourceLine" id="cb24-26" title="26">    EPS_PROP &lt;-<span class="st"> </span><span class="fl">0.117</span></a>
<a class="sourceLine" id="cb24-27" title="27">  })</a>
<a class="sourceLine" id="cb24-28" title="28">  <span class="kw">model</span>({</a>
<a class="sourceLine" id="cb24-29" title="29">    Ka &lt;-<span class="st"> </span>TVKa <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(EKa)</a>
<a class="sourceLine" id="cb24-30" title="30">    CL &lt;-<span class="st"> </span>TVCL <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(ECL)</a>
<a class="sourceLine" id="cb24-31" title="31">    V1 &lt;-<span class="st"> </span>TVV1 <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(EV1)</a>
<a class="sourceLine" id="cb24-32" title="32">    V2 &lt;-<span class="st"> </span>TVV2 <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(EV2)</a>
<a class="sourceLine" id="cb24-33" title="33">    Q &lt;-<span class="st"> </span>TVQ <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(EQ)</a>
<a class="sourceLine" id="cb24-34" title="34">    </a>
<a class="sourceLine" id="cb24-35" title="35">    K12 &lt;-<span class="st"> </span>Q<span class="op">/</span>V1</a>
<a class="sourceLine" id="cb24-36" title="36">    K21 &lt;-<span class="st"> </span>Q<span class="op">/</span>V2</a>
<a class="sourceLine" id="cb24-37" title="37"></a>
<a class="sourceLine" id="cb24-38" title="38">    d<span class="op">/</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/TDist">dt</a></span>(center) =<span class="st"> </span><span class="op">-</span><span class="st"> </span>CL<span class="op">/</span>V1 <span class="op">*</span><span class="st"> </span>center <span class="op">-</span><span class="st"> </span>K12<span class="op">*</span>center <span class="op">+</span><span class="st"> </span>K21 <span class="op">*</span><span class="st"> </span>periph</a>
<a class="sourceLine" id="cb24-39" title="39">    d<span class="op">/</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/TDist">dt</a></span>(periph) =<span class="st"> </span>K12<span class="op">*</span>center <span class="op">-</span><span class="st"> </span>K21 <span class="op">*</span><span class="st"> </span>periph</a>
<a class="sourceLine" id="cb24-40" title="40"></a>
<a class="sourceLine" id="cb24-41" title="41">    CONC =<span class="st"> </span>center <span class="op">/</span><span class="st"> </span>V1 <span class="op">*</span><span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb24-42" title="42">    CONC <span class="op">~</span><span class="st"> </span><span class="kw">prop</span>(EPS_PROP) <span class="op">+</span><span class="st"> </span><span class="kw">add</span>(EPS_ADD)</a>
<a class="sourceLine" id="cb24-43" title="43">  })</a>
<a class="sourceLine" id="cb24-44" title="44">})</a>
<a class="sourceLine" id="cb24-45" title="45"></a>
<a class="sourceLine" id="cb24-46" title="46">m1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tdmore.html">tdmore</a></span>(myModel)</a>
<a class="sourceLine" id="cb24-47" title="47"></a>
<a class="sourceLine" id="cb24-48" title="48">regimen &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cbind">rbind</a></span>(</a>
<a class="sourceLine" id="cb24-49" title="49">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">TIME=</span><span class="dv">0</span>, <span class="dt">AMT=</span><span class="dv">500</span>), <span class="co">#loading dose</span></a>
<a class="sourceLine" id="cb24-50" title="50">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>( <span class="co">#maintenance dose</span></a>
<a class="sourceLine" id="cb24-51" title="51">    <span class="dt">TIME=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sort">sort</a></span>( <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">8</span><span class="op">+</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">20</span>)<span class="op">*</span><span class="dv">24</span>, <span class="dv">20</span><span class="op">+</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">20</span>)<span class="op">*</span><span class="dv">24</span>) ), <span class="co">#at 08:00 and 20:00</span></a>
<a class="sourceLine" id="cb24-52" title="52">    <span class="dt">AMT=</span><span class="dv">88</span></a>
<a class="sourceLine" id="cb24-53" title="53">  )</a>
<a class="sourceLine" id="cb24-54" title="54">)</a>
<a class="sourceLine" id="cb24-55" title="55">obs &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(</a>
<a class="sourceLine" id="cb24-56" title="56">  <span class="dt">TIME=</span>(<span class="dv">3</span><span class="op">*</span><span class="dv">24</span><span class="op">+</span><span class="dv">12</span>)<span class="op">+</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">2</span>)<span class="op">*</span><span class="dv">7</span><span class="op">*</span><span class="dv">24</span>, <span class="co">#observe every 3rd day of the week at noon</span></a>
<a class="sourceLine" id="cb24-57" title="57">  <span class="dt">CONC=</span><span class="ot">NA</span></a>
<a class="sourceLine" id="cb24-58" title="58">)</a>
<a class="sourceLine" id="cb24-59" title="59"></a>
<a class="sourceLine" id="cb24-60" title="60"><span class="co"># predict generates N samples of a tdmorefit with uncertainty</span></a>
<a class="sourceLine" id="cb24-61" title="61"><span class="co"># If we use the population fit, then this will represent a sample across the population.</span></a>
<a class="sourceLine" id="cb24-62" title="62"><span class="co"># I.e. N virtual patients</span></a>
<a class="sourceLine" id="cb24-63" title="63"><span class="co"># In a model with covariates, you should either sample the covariates from an external database,</span></a>
<a class="sourceLine" id="cb24-64" title="64"><span class="co"># or generate them from a distribution.</span></a>
<a class="sourceLine" id="cb24-65" title="65">N &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb24-66" title="66">population &lt;-<span class="st"> </span><span class="kw"><a href="../reference/estimate.html">estimate</a></span>(m1, <span class="dt">regimen=</span>regimen)</a>
<a class="sourceLine" id="cb24-67" title="67">dbPred &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(population, <span class="dt">newdata=</span>obs, <span class="dt">se=</span>T, <span class="dt">level=</span><span class="ot">NA</span>, <span class="dt">mc.maxpts=</span>N) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-68" title="68"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">ID=</span>sample) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-69" title="69"><span class="st">  </span><span class="kw">select</span>(ID, TIME, CONC)</a>
<a class="sourceLine" id="cb24-70" title="70"><span class="co"># We add residual error by sampling from the original model</span></a>
<a class="sourceLine" id="cb24-71" title="71"><span class="co"># This is probably too pessimistic; residual error is rarely truly random...</span></a>
<a class="sourceLine" id="cb24-72" title="72">db &lt;-<span class="st"> </span>dbPred <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-73" title="73"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/model.frame">model.frame</a></span>(m1, <span class="dt">data=</span>., <span class="dt">se=</span><span class="ot">TRUE</span>, <span class="dt">level=</span><span class="ot">NA</span>) <span class="co">#sample residual error</span></a>
<a class="sourceLine" id="cb24-74" title="74"></a>
<a class="sourceLine" id="cb24-75" title="75"><span class="kw">ggplot</span>(dbPred, <span class="kw">aes</span>(<span class="dt">x=</span>TIME, <span class="dt">y=</span>CONC)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-76" title="76"><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">alpha=</span><span class="fl">0.3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-77" title="77"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group=</span>ID), <span class="dt">data=</span>db) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-78" title="78"><span class="st">  </span><span class="kw">geom_smooth</span>()</a>
<a class="sourceLine" id="cb24-79" title="79"></a>
<a class="sourceLine" id="cb24-80" title="80">posthocFit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/posthoc.html">posthoc</a></span>(m1, <span class="dt">regimen=</span>regimen, <span class="dt">observed=</span>db, <span class="dt">se.fit=</span>F, <span class="dt">control=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">factr=</span><span class="fl">1e14</span>))</a>
<a class="sourceLine" id="cb24-81" title="81">posthocFit <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-82" title="82"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">coef =</span> <span class="kw">map</span>(fit, <span class="op">~</span>tibble<span class="op">::</span><span class="kw"><a href="https://tibble.tidyverse.org/reference/enframe.html">enframe</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/coef">coef</a></span>(.x)))) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-83" title="83"><span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span>(coef) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-84" title="84"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>ID, <span class="dt">y=</span>value)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-85" title="85"><span class="st">    </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-86" title="86"><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span>name) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-87" title="87"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">"Eta estimates for posthoc fit"</span>)</a>
<a class="sourceLine" id="cb24-88" title="88"></a>
<a class="sourceLine" id="cb24-89" title="89"><span class="kw">ggplot</span>(db, <span class="kw">aes</span>(<span class="dt">x=</span>TIME, <span class="dt">y=</span>CONC)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-90" title="90"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb24-91" title="91"><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data=</span> posthocFit <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">ipred =</span> <span class="kw">map</span>(fit, predict)) <span class="op">%&gt;%</span><span class="st"> </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span>(ipred) ) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-92" title="92"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>ID) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-93" title="93"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">"Individual fits using all available data"</span>)</a>
<a class="sourceLine" id="cb24-94" title="94"></a>
<a class="sourceLine" id="cb24-95" title="95"><span class="co">## Input data: 'm1', the tdmore model</span></a>
<a class="sourceLine" id="cb24-96" title="96"><span class="co">## Input data: 'db' with columns ID, TIME and CONC</span></a>
<a class="sourceLine" id="cb24-97" title="97"><span class="co">## Input data: 'regimen' with columns TIME and AMT.</span></a>
<a class="sourceLine" id="cb24-98" title="98"><span class="co">## Note that with true retrospective data, the regimen would be different per individual</span></a>
<a class="sourceLine" id="cb24-99" title="99">prosevalDb &lt;-<span class="st"> </span><span class="kw"><a href="../reference/proseval.html">proseval</a></span>(m1, <span class="dt">regimen=</span>regimen, <span class="dt">observed=</span>db, <span class="dt">control=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">factr=</span><span class="fl">1e14</span>))</a>
<a class="sourceLine" id="cb24-100" title="100"></a>
<a class="sourceLine" id="cb24-101" title="101"><span class="co"># Calculate predictions for all data, using the fits</span></a>
<a class="sourceLine" id="cb24-102" title="102">prosevalPred &lt;-<span class="st"> </span>prosevalDb <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-103" title="103"><span class="st">  </span><span class="kw">left_join</span>(db <span class="op">%&gt;%</span><span class="st"> </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span>(<span class="op">-</span>ID), <span class="dt">by=</span><span class="st">"ID"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-104" title="104"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">ipred =</span> <span class="kw">pmap</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(fit, <span class="dt">newdata=</span>data), predict) )</a>
<a class="sourceLine" id="cb24-105" title="105"></a>
<a class="sourceLine" id="cb24-106" title="106">target &lt;-<span class="st"> </span>prosevalPred <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-107" title="107"><span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/unnest.html">unnest</a></span>(data, ipred, <span class="dt">.sep=</span><span class="st">"."</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-108" title="108"><span class="st">  </span><span class="kw">group_by</span>(ID, OBS) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb24-109" title="109"><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(<span class="kw">row_number</span>() <span class="op">==</span><span class="st"> </span>OBS[<span class="dv">1</span>]<span class="op">+</span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st">  </span><span class="co">#pick the next week as a target</span></a>
<a class="sourceLine" id="cb24-110" title="110"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">IRES =</span> data.CONC<span class="op">-</span>ipred.CONC)</a>
<a class="sourceLine" id="cb24-111" title="111"></a>
<a class="sourceLine" id="cb24-112" title="112"><span class="kw">ggplot</span>(target, <span class="kw">aes</span>(<span class="dt">x=</span>IRES)) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-113" title="113"><span class="st">  </span><span class="kw">stat_ecdf</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb24-114" title="114"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept=</span><span class="dv">0</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-115" title="115"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>OBS) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-116" title="116"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">"Absolute prediction error on day i+1</span><span class="ch">\n</span><span class="st">Using on all data available on day i"</span>)</a>
<a class="sourceLine" id="cb24-117" title="117"></a>
<a class="sourceLine" id="cb24-118" title="118">parameters &lt;-<span class="st"> </span>prosevalDb <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-119" title="119"><span class="st">  </span><span class="kw">group_by</span>(ID, OBS) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-120" title="120"><span class="st">  </span><span class="kw">group_modify</span>(<span class="op">~</span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(.x<span class="op">$</span>fit[[<span class="dv">1</span>]], <span class="dt">newdata=</span><span class="dv">0</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-121" title="121"><span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span>(<span class="dt">key=</span>key, <span class="dt">value=</span>value, Ka<span class="op">:</span>V2) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-122" title="122"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">relative=</span>value <span class="op">/</span><span class="st"> </span>value[<span class="dv">1</span>] )</a>
<a class="sourceLine" id="cb24-123" title="123">parameters <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb24-124" title="124"><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>OBS, <span class="dt">y=</span>relative<span class="op">*</span><span class="dv">100</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-125" title="125"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>key, <span class="dt">scales=</span><span class="st">"free"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-126" title="126"><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb24-127" title="127"><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group=</span>ID)) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-128" title="128"><span class="st">  </span><span class="kw">scale_y_log10</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb24-129" title="129"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">"Evolution of parameter values over time"</span>,</a>
<a class="sourceLine" id="cb24-130" title="130">       <span class="dt">y=</span><span class="st">"Relative change (%)"</span>)</a>
<a class="sourceLine" id="cb24-131" title="131"></a>
<a class="sourceLine" id="cb24-132" title="132"><span class="kw">ggplot</span>(target, <span class="kw">aes</span>(<span class="dt">x=</span>ipred.CONC <span class="op">/</span><span class="st"> </span>data.CONC)) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-133" title="133"><span class="st">  </span><span class="kw">stat_ecdf</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb24-134" title="134"><span class="st">  </span><span class="kw">scale_x_log10</span>(<span class="dt">limits=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.5</span>, <span class="dv">2</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-135" title="135"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept=</span><span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-136" title="136"><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.81</span>, <span class="fl">1.22</span>), <span class="dt">linetype=</span><span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-137" title="137"><span class="st">  </span><span class="kw">geom_label</span>(<span class="kw">aes</span>(<span class="dt">x=</span><span class="fl">1.8</span>, <span class="dt">y=</span><span class="fl">0.5</span>, <span class="dt">label=</span>label), <span class="dt">data=</span>. <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(OBS) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">label=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>( <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">round</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(<span class="kw">between</span>(ipred.CONC<span class="op">/</span>data.CONC, <span class="fl">0.81</span>, <span class="fl">1.22</span>))<span class="op">*</span><span class="dv">100</span>), <span class="st">"%"</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-138" title="138"><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>OBS) <span class="op">+</span></a>
<a class="sourceLine" id="cb24-139" title="139"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">"Relative prediction error on day i+1</span><span class="ch">\n</span><span class="st">Using on all data available on day i"</span>)</a>
<a class="sourceLine" id="cb24-140" title="140"></a>
<a class="sourceLine" id="cb24-141" title="141"><span class="co">## NA</span></a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Ruben Faelens, Nicolas Luyckx, Quentin Leirens, FWO TBM Grant.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
