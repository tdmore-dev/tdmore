<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prospective evaluation • tdmore</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Prospective evaluation">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">tdmore</a>
        <span class="version label label-warning" data-toggle="tooltip" data-placement="bottom" title="Parameter estimation is stable, but dose recommendation API is subject to change">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/tdmore.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/comparing-bayesian.html">Comparing historic and bayesian dosing</a>
    </li>
    <li>
      <a href="../articles/dosing-regimen.html">Simulating different dosing regimen</a>
    </li>
    <li>
      <a href="../articles/ggplot.html">Using ggplot to visualize tdmore results</a>
    </li>
    <li>
      <a href="../articles/mpc.html">Model-predictive control</a>
    </li>
    <li>
      <a href="../articles/proseval.html">Prospective evaluation</a>
    </li>
    <li>
      <a href="../articles/tdmore_multiple_endpoints.html">Multiple endpoints in TDMore</a>
    </li>
    <li>
      <a href="../articles/testing_adherence.html">Testing adherence using TDMore</a>
    </li>
  </ul>
</li>
<li>
  <a href="../book/index.html">
    <span class="fa fa-book"></span>
     
    Book
  </a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/tdmore-dev/tdmore">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Prospective evaluation</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tdmore-dev/tdmore/blob/master/vignettes/proseval.Rmd"><code>vignettes/proseval.Rmd</code></a></small>
      <div class="hidden name"><code>proseval.Rmd</code></div>

    </div>

    
    
<div id="about-this-example" class="section level3 unnumbered">
<h3 class="hasAnchor">
<a href="#about-this-example" class="anchor"></a>About this example</h3>
<p>Qualification of non-linear mixed effects models for population PK/PD is a well-studied problem. We can evaluate goodness-of-fit through several standard metrics like LL, AIC, by evaluating a visual predictive check or even evaluating key prediction metrics through a numerical predictive check.</p>
<p>Evaluating how well a model predicts the future for a specific individual is less well-studied. We have settled on using ‘prospective evaluation’. This technique splits the individual data in a training and validation dataset: anything before a given timepoint <code>t_i</code> is used to calculate the individual fit, anything after <code>t_i</code> is used to evaluate how well this fit predicts the future. By repeating this exercise for every possible <code>t_i</code>, we can evaluate how well we predict the future at day 1, day 2, etc.</p>
<p>This vignette shows how to use <code>tdmore</code> in such an evaluation. This is also called a <em>prospective evaluation</em>, and has been (rudimentarily) implemented in the <a href="https://github.com/UUPharmacometrics/PsN/releases/download/4.9.0/proseval_userguide.pdf" title="proseval manual page">PsN proseval</a> routine.</p>
</div>
<div id="example-model" class="section level3">
<h3 class="hasAnchor">
<a href="#example-model" class="anchor"></a>Example model</h3>
<p>We use an example model from literature.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># Model taken from literature: Soulele, K., et al.</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co"># 'Population pharmacokinetics of fluticasone propionate/salmeterol using two different dry powder inhalers.'</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co"># European Journal of Pharmaceutical Sciences 80 (2015): 33-42."</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>myModel &lt;-<span class="st"> </span>nlmixr<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/nlmixr/man/nlmixrUI.html">nlmixrUI</a></span>(<span class="cf">function</span>(){</span>
<span id="cb1-5"><a href="#cb1-5"></a>  <span class="kw">ini</span>({</span>
<span id="cb1-6"><a href="#cb1-6"></a>    TVKa &lt;-<span class="st"> </span><span class="fl">3.87</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>    TVCL &lt;-<span class="st"> </span><span class="dv">659</span>    <span class="co"># L/h</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>    TVV1 &lt;-<span class="st"> </span><span class="dv">56900</span>  <span class="co"># L</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>    TVV2 &lt;-<span class="st"> </span><span class="dv">5550</span>   <span class="co"># L</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>    TVQ &lt;-<span class="st"> </span><span class="dv">259</span>     <span class="co"># L/h</span></span>
<span id="cb1-11"><a href="#cb1-11"></a></span>
<span id="cb1-12"><a href="#cb1-12"></a>    EKa <span class="op">~</span><span class="st"> </span><span class="fl">0.04507129</span>  <span class="co"># 0.2123**2</span></span>
<span id="cb1-13"><a href="#cb1-13"></a>    ECL <span class="op">~</span><span class="st"> </span><span class="fl">0.1535856</span>   <span class="co"># 0.3919**2</span></span>
<span id="cb1-14"><a href="#cb1-14"></a>    EV1 <span class="op">~</span><span class="st"> </span><span class="fl">0.09223369</span>  <span class="co"># 0.3037**2</span></span>
<span id="cb1-15"><a href="#cb1-15"></a>    EV2 <span class="op">~</span><span class="st"> </span><span class="fl">0.208301</span>    <span class="co"># 0.4564**2</span></span>
<span id="cb1-16"><a href="#cb1-16"></a>    EQ <span class="op">~</span><span class="st"> </span><span class="fl">0.1015697</span>    <span class="co"># 0.3187**2</span></span>
<span id="cb1-17"><a href="#cb1-17"></a></span>
<span id="cb1-18"><a href="#cb1-18"></a>    EPS_ADD &lt;-<span class="st"> </span><span class="fl">1.91</span></span>
<span id="cb1-19"><a href="#cb1-19"></a>    EPS_PROP &lt;-<span class="st"> </span><span class="fl">0.117</span></span>
<span id="cb1-20"><a href="#cb1-20"></a>  })</span>
<span id="cb1-21"><a href="#cb1-21"></a>  <span class="kw">model</span>({</span>
<span id="cb1-22"><a href="#cb1-22"></a>    Ka &lt;-<span class="st"> </span>TVKa <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(EKa)</span>
<span id="cb1-23"><a href="#cb1-23"></a>    CL &lt;-<span class="st"> </span>TVCL <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(ECL)</span>
<span id="cb1-24"><a href="#cb1-24"></a>    V1 &lt;-<span class="st"> </span>TVV1 <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(EV1)</span>
<span id="cb1-25"><a href="#cb1-25"></a>    V2 &lt;-<span class="st"> </span>TVV2 <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(EV2)</span>
<span id="cb1-26"><a href="#cb1-26"></a>    Q &lt;-<span class="st"> </span>TVQ <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(EQ)</span>
<span id="cb1-27"><a href="#cb1-27"></a>    </span>
<span id="cb1-28"><a href="#cb1-28"></a>    K12 &lt;-<span class="st"> </span>Q<span class="op">/</span>V1</span>
<span id="cb1-29"><a href="#cb1-29"></a>    K21 &lt;-<span class="st"> </span>Q<span class="op">/</span>V2</span>
<span id="cb1-30"><a href="#cb1-30"></a></span>
<span id="cb1-31"><a href="#cb1-31"></a>    d<span class="op">/</span><span class="kw"><a href="https://rdrr.io/r/stats/TDist.html">dt</a></span>(center) =<span class="st"> </span><span class="op">-</span><span class="st"> </span>CL<span class="op">/</span>V1 <span class="op">*</span><span class="st"> </span>center <span class="op">-</span><span class="st"> </span>K12<span class="op">*</span>center <span class="op">+</span><span class="st"> </span>K21 <span class="op">*</span><span class="st"> </span>periph</span>
<span id="cb1-32"><a href="#cb1-32"></a>    d<span class="op">/</span><span class="kw"><a href="https://rdrr.io/r/stats/TDist.html">dt</a></span>(periph) =<span class="st"> </span>K12<span class="op">*</span>center <span class="op">-</span><span class="st"> </span>K21 <span class="op">*</span><span class="st"> </span>periph</span>
<span id="cb1-33"><a href="#cb1-33"></a></span>
<span id="cb1-34"><a href="#cb1-34"></a>    CONC =<span class="st"> </span>center <span class="op">/</span><span class="st"> </span>V1 <span class="op">*</span><span class="st"> </span><span class="dv">1000</span></span>
<span id="cb1-35"><a href="#cb1-35"></a>    CONC <span class="op">~</span><span class="st"> </span><span class="kw">prop</span>(EPS_PROP) <span class="op">+</span><span class="st"> </span><span class="kw">add</span>(EPS_ADD)</span>
<span id="cb1-36"><a href="#cb1-36"></a>  })</span>
<span id="cb1-37"><a href="#cb1-37"></a>})</span>
<span id="cb1-38"><a href="#cb1-38"></a></span>
<span id="cb1-39"><a href="#cb1-39"></a>m1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tdmore.html">tdmore</a></span>(myModel)</span></code></pre></div>
</div>
<div id="source-data-in-silico-simulation" class="section level3">
<h3 class="hasAnchor">
<a href="#source-data-in-silico-simulation" class="anchor"></a>Source data: in silico simulation</h3>
<p>Without a source dataset, we can generate data from an in silico simulation. Below, we use the standard treatment regimen of 88mcg twice-daily, with blood samples every week.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a>regimen &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(</span>
<span id="cb2-2"><a href="#cb2-2"></a>  <span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">TIME=</span><span class="dv">0</span>, <span class="dt">AMT=</span><span class="dv">500</span>), <span class="co">#loading dose</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>  <span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>( <span class="co">#maintenance dose</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>    <span class="dt">TIME=</span><span class="kw"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>( <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">8</span><span class="op">+</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">20</span>)<span class="op">*</span><span class="dv">24</span>, <span class="dv">20</span><span class="op">+</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">20</span>)<span class="op">*</span><span class="dv">24</span>) ), <span class="co">#at 08:00 and 20:00</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>    <span class="dt">AMT=</span><span class="dv">88</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>  )</span>
<span id="cb2-7"><a href="#cb2-7"></a>)</span>
<span id="cb2-8"><a href="#cb2-8"></a>obs &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(</span>
<span id="cb2-9"><a href="#cb2-9"></a>  <span class="dt">TIME=</span>(<span class="dv">3</span><span class="op">*</span><span class="dv">24</span><span class="op">+</span><span class="dv">12</span>)<span class="op">+</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">2</span>)<span class="op">*</span><span class="dv">7</span><span class="op">*</span><span class="dv">24</span>, <span class="co">#observe every 3rd day of the week at noon</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>  <span class="dt">CONC=</span><span class="ot">NA</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>)</span>
<span id="cb2-12"><a href="#cb2-12"></a></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="co"># predict generates N samples of a tdmorefit with uncertainty</span></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="co"># If we use the population fit, then this will represent a sample across the population.</span></span>
<span id="cb2-15"><a href="#cb2-15"></a><span class="co"># I.e. N virtual subjects</span></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="co"># In a model with covariates, you should either sample the covariates from an external database,</span></span>
<span id="cb2-17"><a href="#cb2-17"></a><span class="co"># or generate them from a distribution.</span></span>
<span id="cb2-18"><a href="#cb2-18"></a>N &lt;-<span class="st"> </span><span class="dv">10</span></span>
<span id="cb2-19"><a href="#cb2-19"></a>population &lt;-<span class="st"> </span><span class="kw"><a href="../reference/estimate.html">estimate</a></span>(m1, <span class="dt">regimen=</span>regimen)</span>
<span id="cb2-20"><a href="#cb2-20"></a>dbPred &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(population, <span class="dt">newdata=</span>obs, <span class="dt">se=</span>T, <span class="dt">level=</span><span class="ot">NA</span>, <span class="dt">mc.maxpts=</span>N) <span class="op">%&gt;%</span></span>
<span id="cb2-21"><a href="#cb2-21"></a><span class="st">  </span><span class="kw">rename</span>(<span class="dt">ID=</span>sample) <span class="op">%&gt;%</span></span>
<span id="cb2-22"><a href="#cb2-22"></a><span class="st">  </span><span class="kw">select</span>(ID, TIME, CONC)</span>
<span id="cb2-23"><a href="#cb2-23"></a><span class="co"># We add residual error by sampling from the original model</span></span>
<span id="cb2-24"><a href="#cb2-24"></a><span class="co"># This is probably too pessimistic; residual error is rarely truly random...</span></span>
<span id="cb2-25"><a href="#cb2-25"></a>db &lt;-<span class="st"> </span>dbPred <span class="op">%&gt;%</span></span>
<span id="cb2-26"><a href="#cb2-26"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/model.frame.html">model.frame</a></span>(m1, <span class="dt">data=</span>., <span class="dt">se=</span><span class="ot">TRUE</span>, <span class="dt">level=</span><span class="ot">NA</span>) <span class="co">#sample residual error</span></span>
<span id="cb2-27"><a href="#cb2-27"></a></span>
<span id="cb2-28"><a href="#cb2-28"></a><span class="kw">ggplot</span>(dbPred, <span class="kw">aes</span>(<span class="dt">x=</span>TIME, <span class="dt">y=</span>CONC)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb2-29"><a href="#cb2-29"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">alpha=</span><span class="fl">0.3</span>) <span class="op">+</span></span>
<span id="cb2-30"><a href="#cb2-30"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group=</span>ID), <span class="dt">data=</span>db) <span class="op">+</span></span>
<span id="cb2-31"><a href="#cb2-31"></a><span class="st">  </span><span class="kw">geom_smooth</span>()</span></code></pre></div>
<p><img src="proseval_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>posthocFit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/dataTibble.html">dataTibble</a></span>(<span class="dt">object=</span>m1, <span class="dt">regimen=</span>regimen, <span class="dt">observed=</span>db) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/posthoc.html">posthoc</a></span>(<span class="dt">se.fit=</span>F, <span class="dt">control=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">factr=</span><span class="fl">1e14</span>))</span>
<span id="cb3-2"><a href="#cb3-2"></a>posthocFit <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">coef =</span> <span class="kw">map</span>(fit, <span class="op">~</span>tibble<span class="op">::</span><span class="kw"><a href="https://tibble.tidyverse.org/reference/enframe.html">enframe</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(.x)))) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span>(coef) <span class="op">%&gt;%</span></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>ID, <span class="dt">y=</span>value)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb3-6"><a href="#cb3-6"></a><span class="st">    </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb3-7"><a href="#cb3-7"></a><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span>name) <span class="op">+</span></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="st">    </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">"Eta estimates for posthoc fit"</span>)</span></code></pre></div>
<p><img src="proseval_files/figure-html/unnamed-chunk-3-2.png" width="700"></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">ggplot</span>(db, <span class="kw">aes</span>(<span class="dt">x=</span>TIME, <span class="dt">y=</span>CONC)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data=</span> posthocFit <span class="op">%&gt;%</span><span class="st"> </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span>(ipred) ) <span class="op">+</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>ID) <span class="op">+</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">"Individual fits using all available data"</span>)</span></code></pre></div>
<p><img src="proseval_files/figure-html/unnamed-chunk-3-3.png" width="700"></p>
</div>
<div id="source-data-retrospective-data" class="section level3">
<h3 class="hasAnchor">
<a href="#source-data-retrospective-data" class="anchor"></a>Source data: retrospective data</h3>
<p>A retrospective dataset can also be used. Aggregating this data across individuals may be difficult if there are large differences in treatment, observation schedule or adherence. Furthermore, a decision should be made up-front on how to treat missing values.</p>
<p>As an example: If we evaluate how well we predict day3 using day 1+2 data, should we…</p>
<ol style="list-style-type: lower-alpha">
<li>discard subjects with missing data on day3 (target), as there is no point of reference in this case?</li>
<li>discard subjects with missing data on day1 or day2, as there is less data to calculate an accurate fit?</li>
</ol>
<p>This can be solved by using all data to generate an individual fit, and predicting (interpolating) missing data.</p>
</div>
<div id="calculating-prospective-evaluation" class="section level3 unnumbered">
<h3 class="hasAnchor">
<a href="#calculating-prospective-evaluation" class="anchor"></a>Calculating prospective evaluation</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co">## Input data: 'm1', the tdmore model</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co">## Input data: 'db' with columns ID, TIME and CONC</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="co">## Input data: 'regimen' with columns TIME and AMT.</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="co">## Note that with true retrospective data, the regimen would be different per individual</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>prosevalDb &lt;-<span class="st"> </span><span class="kw"><a href="../reference/dataTibble.html">dataTibble</a></span>(<span class="dt">object=</span>m1, <span class="dt">regimen=</span>regimen, <span class="dt">observed=</span>db) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/posthoc.html">proseval</a></span>(<span class="dt">control=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">factr=</span><span class="fl">1e14</span>))</span></code></pre></div>
</div>
<div id="graphical-representation" class="section level3 unnumbered">
<h3 class="hasAnchor">
<a href="#graphical-representation" class="anchor"></a>Graphical representation</h3>
<p>We now have a list of prospective evaluations for every subject. Suppose we want to use the model to modify the dose for next week. In that case, we want to check how well a prospective evaluation predicts next week.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="co"># Calculate predictions for all data, using the fits</span></span>
<span id="cb6-2"><a href="#cb6-2"></a>target &lt;-<span class="st"> </span>prosevalDb <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="st">  </span><span class="kw">left_join</span>(db <span class="op">%&gt;%</span><span class="st"> </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span>(<span class="op">-</span>ID), <span class="dt">by=</span><span class="st">"ID"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># add original data</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span>(data, ipred, <span class="dt">.sep=</span><span class="st">"."</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># unnest, creating data.CONC and ipred.CONC columns</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="st">  </span><span class="kw">group_by</span>(ID, OBS) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">row_number</span>() <span class="op">==</span><span class="st"> </span>OBS[<span class="dv">1</span>]<span class="op">+</span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st">  </span><span class="co">#pick the next week as a target</span></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">IRES =</span> data.CONC<span class="op">-</span>ipred.CONC)</span></code></pre></div>
<pre><code>## Warning: All elements of `...` must be named.
## Did you want `data = c(TIME, CONC)`?</code></pre>
<pre><code>## Warning: unnest() has a new interface. See ?unnest for details.
## Try `df %&gt;% unnest(c(data, ipred))`, with `mutate()` if needed</code></pre>
<pre><code>## Warning: The `.sep` argument of `unnest()` is deprecated as of tidyr 1.0.0.
## Use `names_sep = '.'` instead.
## This warning is displayed once per session.
## Call `lifecycle::last_warnings()` to see where this warning was generated.</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">ggplot</span>(target, <span class="kw">aes</span>(<span class="dt">x=</span>IRES)) <span class="op">+</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="st">  </span><span class="kw">stat_ecdf</span>() <span class="op">+</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept=</span><span class="dv">0</span>) <span class="op">+</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>OBS) <span class="op">+</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">"Absolute prediction error on day i+1</span><span class="ch">\n</span><span class="st">Using on all data available on day i"</span>)</span></code></pre></div>
<p><img src="proseval_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>parameters &lt;-<span class="st"> </span>prosevalDb <span class="op">%&gt;%</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="st">  </span><span class="kw">group_by</span>(ID, OBS) <span class="op">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="st">  </span><span class="kw">group_modify</span>(<span class="op">~</span><span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(.x<span class="op">$</span>fit[[<span class="dv">1</span>]], <span class="dt">newdata=</span><span class="dv">0</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="co">#predict time=0</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span>(<span class="dt">key=</span>key, <span class="dt">value=</span>value, Ka<span class="op">:</span>V2) <span class="op">%&gt;%</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="st">  </span><span class="kw">group_by</span>(ID, key) <span class="op">%&gt;%</span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">relative=</span>(value<span class="op">-</span>value[<span class="dv">1</span>])<span class="op">/</span>value)</span></code></pre></div>
<pre><code>## Warning: Grouping rowwise data frame strips rowwise nature</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>parameters <span class="op">%&gt;%</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>OBS, <span class="dt">y=</span>relative<span class="op">*</span><span class="dv">100</span>)) <span class="op">+</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>key, <span class="dt">scales=</span><span class="st">"free"</span>) <span class="op">+</span></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group=</span>ID)) <span class="op">+</span></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">"Evolution of parameter values over time"</span>,</span>
<span id="cb13-7"><a href="#cb13-7"></a>       <span class="dt">y=</span><span class="st">"Relative change (%)"</span>)</span></code></pre></div>
<p><img src="proseval_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
</div>
<div id="how-does-this-impact-dose-adaptation" class="section level3 unnumbered">
<h3 class="hasAnchor">
<a href="#how-does-this-impact-dose-adaptation" class="anchor"></a>How does this impact dose adaptation?</h3>
<p>The better a model can predict the future, the more accurate it can calculate the dose to reach a given target. A rough indication for “% on target” is to calculate <code>IPRED / DV</code>. If this is higher than 1, then the model is overpredicting (and will underdose). If this is lower than 1, the model is underpredicting (and will overdose). Assuming your target window is e.g. between 10 and 15, the log-mean is <code><a href="https://rdrr.io/r/base/Log.html">exp( mean( log(c(10,15)) ) )</a></code> and the relative error should be between <code>0.81</code> and <code>1.22</code>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="kw">ggplot</span>(target, <span class="kw">aes</span>(<span class="dt">x=</span>ipred.CONC <span class="op">/</span><span class="st"> </span>data.CONC)) <span class="op">+</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="st">  </span><span class="kw">stat_ecdf</span>() <span class="op">+</span></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="st">  </span><span class="kw">scale_x_log10</span>(<span class="dt">limits=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.5</span>, <span class="dv">2</span>)) <span class="op">+</span></span>
<span id="cb14-4"><a href="#cb14-4"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept=</span><span class="dv">1</span>) <span class="op">+</span></span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.81</span>, <span class="fl">1.22</span>), <span class="dt">linetype=</span><span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="st">  </span><span class="kw">geom_label</span>(<span class="kw">aes</span>(<span class="dt">x=</span><span class="fl">1.8</span>, <span class="dt">y=</span><span class="fl">0.5</span>, <span class="dt">label=</span>label), <span class="dt">data=</span>. <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(OBS) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">label=</span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>( <span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="kw">between</span>(ipred.CONC<span class="op">/</span>data.CONC, <span class="fl">0.81</span>, <span class="fl">1.22</span>))<span class="op">*</span><span class="dv">100</span>), <span class="st">"%"</span>))) <span class="op">+</span></span>
<span id="cb14-7"><a href="#cb14-7"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>OBS) <span class="op">+</span></span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">"Relative prediction error on day i+1</span><span class="ch">\n</span><span class="st">Using on all data available on day i"</span>, <span class="dt">caption=</span><span class="st">"White boxes represent % of patients in target"</span>)</span></code></pre></div>
<p><img src="proseval_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
</div>
<div id="code-appendix" class="section level3">
<h3 class="hasAnchor">
<a href="#code-appendix" class="anchor"></a>Code appendix</h3>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tdmore)</span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(dplyr)</span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(purrr)</span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(tidyr)</span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span>(ggplot2)</span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="kw"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="dv">1234</span>)</span>
<span id="cb15-7"><a href="#cb15-7"></a><span class="co"># Model taken from literature: Soulele, K., et al.</span></span>
<span id="cb15-8"><a href="#cb15-8"></a><span class="co"># 'Population pharmacokinetics of fluticasone propionate/salmeterol using two different dry powder inhalers.'</span></span>
<span id="cb15-9"><a href="#cb15-9"></a><span class="co"># European Journal of Pharmaceutical Sciences 80 (2015): 33-42."</span></span>
<span id="cb15-10"><a href="#cb15-10"></a>myModel &lt;-<span class="st"> </span>nlmixr<span class="op">::</span><span class="kw"><a href="https://rdrr.io/pkg/nlmixr/man/nlmixrUI.html">nlmixrUI</a></span>(<span class="cf">function</span>(){</span>
<span id="cb15-11"><a href="#cb15-11"></a>  <span class="kw">ini</span>({</span>
<span id="cb15-12"><a href="#cb15-12"></a>    TVKa &lt;-<span class="st"> </span><span class="fl">3.87</span></span>
<span id="cb15-13"><a href="#cb15-13"></a>    TVCL &lt;-<span class="st"> </span><span class="dv">659</span>    <span class="co"># L/h</span></span>
<span id="cb15-14"><a href="#cb15-14"></a>    TVV1 &lt;-<span class="st"> </span><span class="dv">56900</span>  <span class="co"># L</span></span>
<span id="cb15-15"><a href="#cb15-15"></a>    TVV2 &lt;-<span class="st"> </span><span class="dv">5550</span>   <span class="co"># L</span></span>
<span id="cb15-16"><a href="#cb15-16"></a>    TVQ &lt;-<span class="st"> </span><span class="dv">259</span>     <span class="co"># L/h</span></span>
<span id="cb15-17"><a href="#cb15-17"></a></span>
<span id="cb15-18"><a href="#cb15-18"></a>    EKa <span class="op">~</span><span class="st"> </span><span class="fl">0.04507129</span>  <span class="co"># 0.2123**2</span></span>
<span id="cb15-19"><a href="#cb15-19"></a>    ECL <span class="op">~</span><span class="st"> </span><span class="fl">0.1535856</span>   <span class="co"># 0.3919**2</span></span>
<span id="cb15-20"><a href="#cb15-20"></a>    EV1 <span class="op">~</span><span class="st"> </span><span class="fl">0.09223369</span>  <span class="co"># 0.3037**2</span></span>
<span id="cb15-21"><a href="#cb15-21"></a>    EV2 <span class="op">~</span><span class="st"> </span><span class="fl">0.208301</span>    <span class="co"># 0.4564**2</span></span>
<span id="cb15-22"><a href="#cb15-22"></a>    EQ <span class="op">~</span><span class="st"> </span><span class="fl">0.1015697</span>    <span class="co"># 0.3187**2</span></span>
<span id="cb15-23"><a href="#cb15-23"></a></span>
<span id="cb15-24"><a href="#cb15-24"></a>    EPS_ADD &lt;-<span class="st"> </span><span class="fl">1.91</span></span>
<span id="cb15-25"><a href="#cb15-25"></a>    EPS_PROP &lt;-<span class="st"> </span><span class="fl">0.117</span></span>
<span id="cb15-26"><a href="#cb15-26"></a>  })</span>
<span id="cb15-27"><a href="#cb15-27"></a>  <span class="kw">model</span>({</span>
<span id="cb15-28"><a href="#cb15-28"></a>    Ka &lt;-<span class="st"> </span>TVKa <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(EKa)</span>
<span id="cb15-29"><a href="#cb15-29"></a>    CL &lt;-<span class="st"> </span>TVCL <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(ECL)</span>
<span id="cb15-30"><a href="#cb15-30"></a>    V1 &lt;-<span class="st"> </span>TVV1 <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(EV1)</span>
<span id="cb15-31"><a href="#cb15-31"></a>    V2 &lt;-<span class="st"> </span>TVV2 <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(EV2)</span>
<span id="cb15-32"><a href="#cb15-32"></a>    Q &lt;-<span class="st"> </span>TVQ <span class="op">*</span><span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(EQ)</span>
<span id="cb15-33"><a href="#cb15-33"></a>    </span>
<span id="cb15-34"><a href="#cb15-34"></a>    K12 &lt;-<span class="st"> </span>Q<span class="op">/</span>V1</span>
<span id="cb15-35"><a href="#cb15-35"></a>    K21 &lt;-<span class="st"> </span>Q<span class="op">/</span>V2</span>
<span id="cb15-36"><a href="#cb15-36"></a></span>
<span id="cb15-37"><a href="#cb15-37"></a>    d<span class="op">/</span><span class="kw"><a href="https://rdrr.io/r/stats/TDist.html">dt</a></span>(center) =<span class="st"> </span><span class="op">-</span><span class="st"> </span>CL<span class="op">/</span>V1 <span class="op">*</span><span class="st"> </span>center <span class="op">-</span><span class="st"> </span>K12<span class="op">*</span>center <span class="op">+</span><span class="st"> </span>K21 <span class="op">*</span><span class="st"> </span>periph</span>
<span id="cb15-38"><a href="#cb15-38"></a>    d<span class="op">/</span><span class="kw"><a href="https://rdrr.io/r/stats/TDist.html">dt</a></span>(periph) =<span class="st"> </span>K12<span class="op">*</span>center <span class="op">-</span><span class="st"> </span>K21 <span class="op">*</span><span class="st"> </span>periph</span>
<span id="cb15-39"><a href="#cb15-39"></a></span>
<span id="cb15-40"><a href="#cb15-40"></a>    CONC =<span class="st"> </span>center <span class="op">/</span><span class="st"> </span>V1 <span class="op">*</span><span class="st"> </span><span class="dv">1000</span></span>
<span id="cb15-41"><a href="#cb15-41"></a>    CONC <span class="op">~</span><span class="st"> </span><span class="kw">prop</span>(EPS_PROP) <span class="op">+</span><span class="st"> </span><span class="kw">add</span>(EPS_ADD)</span>
<span id="cb15-42"><a href="#cb15-42"></a>  })</span>
<span id="cb15-43"><a href="#cb15-43"></a>})</span>
<span id="cb15-44"><a href="#cb15-44"></a></span>
<span id="cb15-45"><a href="#cb15-45"></a>m1 &lt;-<span class="st"> </span><span class="kw"><a href="../reference/tdmore.html">tdmore</a></span>(myModel)</span>
<span id="cb15-46"><a href="#cb15-46"></a>regimen &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(</span>
<span id="cb15-47"><a href="#cb15-47"></a>  <span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="dt">TIME=</span><span class="dv">0</span>, <span class="dt">AMT=</span><span class="dv">500</span>), <span class="co">#loading dose</span></span>
<span id="cb15-48"><a href="#cb15-48"></a>  <span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>( <span class="co">#maintenance dose</span></span>
<span id="cb15-49"><a href="#cb15-49"></a>    <span class="dt">TIME=</span><span class="kw"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>( <span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="dv">8</span><span class="op">+</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">20</span>)<span class="op">*</span><span class="dv">24</span>, <span class="dv">20</span><span class="op">+</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">20</span>)<span class="op">*</span><span class="dv">24</span>) ), <span class="co">#at 08:00 and 20:00</span></span>
<span id="cb15-50"><a href="#cb15-50"></a>    <span class="dt">AMT=</span><span class="dv">88</span></span>
<span id="cb15-51"><a href="#cb15-51"></a>  )</span>
<span id="cb15-52"><a href="#cb15-52"></a>)</span>
<span id="cb15-53"><a href="#cb15-53"></a>obs &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(</span>
<span id="cb15-54"><a href="#cb15-54"></a>  <span class="dt">TIME=</span>(<span class="dv">3</span><span class="op">*</span><span class="dv">24</span><span class="op">+</span><span class="dv">12</span>)<span class="op">+</span>(<span class="dv">0</span><span class="op">:</span><span class="dv">2</span>)<span class="op">*</span><span class="dv">7</span><span class="op">*</span><span class="dv">24</span>, <span class="co">#observe every 3rd day of the week at noon</span></span>
<span id="cb15-55"><a href="#cb15-55"></a>  <span class="dt">CONC=</span><span class="ot">NA</span></span>
<span id="cb15-56"><a href="#cb15-56"></a>)</span>
<span id="cb15-57"><a href="#cb15-57"></a></span>
<span id="cb15-58"><a href="#cb15-58"></a><span class="co"># predict generates N samples of a tdmorefit with uncertainty</span></span>
<span id="cb15-59"><a href="#cb15-59"></a><span class="co"># If we use the population fit, then this will represent a sample across the population.</span></span>
<span id="cb15-60"><a href="#cb15-60"></a><span class="co"># I.e. N virtual subjects</span></span>
<span id="cb15-61"><a href="#cb15-61"></a><span class="co"># In a model with covariates, you should either sample the covariates from an external database,</span></span>
<span id="cb15-62"><a href="#cb15-62"></a><span class="co"># or generate them from a distribution.</span></span>
<span id="cb15-63"><a href="#cb15-63"></a>N &lt;-<span class="st"> </span><span class="dv">10</span></span>
<span id="cb15-64"><a href="#cb15-64"></a>population &lt;-<span class="st"> </span><span class="kw"><a href="../reference/estimate.html">estimate</a></span>(m1, <span class="dt">regimen=</span>regimen)</span>
<span id="cb15-65"><a href="#cb15-65"></a>dbPred &lt;-<span class="st"> </span><span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(population, <span class="dt">newdata=</span>obs, <span class="dt">se=</span>T, <span class="dt">level=</span><span class="ot">NA</span>, <span class="dt">mc.maxpts=</span>N) <span class="op">%&gt;%</span></span>
<span id="cb15-66"><a href="#cb15-66"></a><span class="st">  </span><span class="kw">rename</span>(<span class="dt">ID=</span>sample) <span class="op">%&gt;%</span></span>
<span id="cb15-67"><a href="#cb15-67"></a><span class="st">  </span><span class="kw">select</span>(ID, TIME, CONC)</span>
<span id="cb15-68"><a href="#cb15-68"></a><span class="co"># We add residual error by sampling from the original model</span></span>
<span id="cb15-69"><a href="#cb15-69"></a><span class="co"># This is probably too pessimistic; residual error is rarely truly random...</span></span>
<span id="cb15-70"><a href="#cb15-70"></a>db &lt;-<span class="st"> </span>dbPred <span class="op">%&gt;%</span></span>
<span id="cb15-71"><a href="#cb15-71"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/model.frame.html">model.frame</a></span>(m1, <span class="dt">data=</span>., <span class="dt">se=</span><span class="ot">TRUE</span>, <span class="dt">level=</span><span class="ot">NA</span>) <span class="co">#sample residual error</span></span>
<span id="cb15-72"><a href="#cb15-72"></a></span>
<span id="cb15-73"><a href="#cb15-73"></a><span class="kw">ggplot</span>(dbPred, <span class="kw">aes</span>(<span class="dt">x=</span>TIME, <span class="dt">y=</span>CONC)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb15-74"><a href="#cb15-74"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">alpha=</span><span class="fl">0.3</span>) <span class="op">+</span></span>
<span id="cb15-75"><a href="#cb15-75"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group=</span>ID), <span class="dt">data=</span>db) <span class="op">+</span></span>
<span id="cb15-76"><a href="#cb15-76"></a><span class="st">  </span><span class="kw">geom_smooth</span>()</span>
<span id="cb15-77"><a href="#cb15-77"></a></span>
<span id="cb15-78"><a href="#cb15-78"></a>posthocFit &lt;-<span class="st"> </span><span class="kw"><a href="../reference/dataTibble.html">dataTibble</a></span>(<span class="dt">object=</span>m1, <span class="dt">regimen=</span>regimen, <span class="dt">observed=</span>db) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/posthoc.html">posthoc</a></span>(<span class="dt">se.fit=</span>F, <span class="dt">control=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">factr=</span><span class="fl">1e14</span>))</span>
<span id="cb15-79"><a href="#cb15-79"></a>posthocFit <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></span>
<span id="cb15-80"><a href="#cb15-80"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">coef =</span> <span class="kw">map</span>(fit, <span class="op">~</span>tibble<span class="op">::</span><span class="kw"><a href="https://tibble.tidyverse.org/reference/enframe.html">enframe</a></span>(<span class="kw"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(.x)))) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb15-81"><a href="#cb15-81"></a><span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span>(coef) <span class="op">%&gt;%</span></span>
<span id="cb15-82"><a href="#cb15-82"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>ID, <span class="dt">y=</span>value)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb15-83"><a href="#cb15-83"></a><span class="st">    </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb15-84"><a href="#cb15-84"></a><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span>name) <span class="op">+</span></span>
<span id="cb15-85"><a href="#cb15-85"></a><span class="st">    </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">"Eta estimates for posthoc fit"</span>)</span>
<span id="cb15-86"><a href="#cb15-86"></a></span>
<span id="cb15-87"><a href="#cb15-87"></a><span class="kw">ggplot</span>(db, <span class="kw">aes</span>(<span class="dt">x=</span>TIME, <span class="dt">y=</span>CONC)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb15-88"><a href="#cb15-88"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb15-89"><a href="#cb15-89"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="dt">data=</span> posthocFit <span class="op">%&gt;%</span><span class="st"> </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span>(ipred) ) <span class="op">+</span></span>
<span id="cb15-90"><a href="#cb15-90"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>ID) <span class="op">+</span></span>
<span id="cb15-91"><a href="#cb15-91"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">"Individual fits using all available data"</span>)</span>
<span id="cb15-92"><a href="#cb15-92"></a><span class="co">## Input data: 'm1', the tdmore model</span></span>
<span id="cb15-93"><a href="#cb15-93"></a><span class="co">## Input data: 'db' with columns ID, TIME and CONC</span></span>
<span id="cb15-94"><a href="#cb15-94"></a><span class="co">## Input data: 'regimen' with columns TIME and AMT.</span></span>
<span id="cb15-95"><a href="#cb15-95"></a><span class="co">## Note that with true retrospective data, the regimen would be different per individual</span></span>
<span id="cb15-96"><a href="#cb15-96"></a>prosevalDb &lt;-<span class="st"> </span><span class="kw"><a href="../reference/dataTibble.html">dataTibble</a></span>(<span class="dt">object=</span>m1, <span class="dt">regimen=</span>regimen, <span class="dt">observed=</span>db) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="../reference/posthoc.html">proseval</a></span>(<span class="dt">control=</span><span class="kw"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="dt">factr=</span><span class="fl">1e14</span>))</span>
<span id="cb15-97"><a href="#cb15-97"></a><span class="co"># Calculate predictions for all data, using the fits</span></span>
<span id="cb15-98"><a href="#cb15-98"></a>target &lt;-<span class="st"> </span>prosevalDb <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb15-99"><a href="#cb15-99"></a><span class="st">  </span><span class="kw">left_join</span>(db <span class="op">%&gt;%</span><span class="st"> </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/nest.html">nest</a></span>(<span class="op">-</span>ID), <span class="dt">by=</span><span class="st">"ID"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># add original data</span></span>
<span id="cb15-100"><a href="#cb15-100"></a><span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/nest.html">unnest</a></span>(data, ipred, <span class="dt">.sep=</span><span class="st">"."</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># unnest, creating data.CONC and ipred.CONC columns</span></span>
<span id="cb15-101"><a href="#cb15-101"></a><span class="st">  </span><span class="kw">group_by</span>(ID, OBS) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb15-102"><a href="#cb15-102"></a><span class="st">  </span><span class="kw"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="kw">row_number</span>() <span class="op">==</span><span class="st"> </span>OBS[<span class="dv">1</span>]<span class="op">+</span><span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st">  </span><span class="co">#pick the next week as a target</span></span>
<span id="cb15-103"><a href="#cb15-103"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">IRES =</span> data.CONC<span class="op">-</span>ipred.CONC)</span>
<span id="cb15-104"><a href="#cb15-104"></a></span>
<span id="cb15-105"><a href="#cb15-105"></a><span class="kw">ggplot</span>(target, <span class="kw">aes</span>(<span class="dt">x=</span>IRES)) <span class="op">+</span></span>
<span id="cb15-106"><a href="#cb15-106"></a><span class="st">  </span><span class="kw">stat_ecdf</span>() <span class="op">+</span></span>
<span id="cb15-107"><a href="#cb15-107"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept=</span><span class="dv">0</span>) <span class="op">+</span></span>
<span id="cb15-108"><a href="#cb15-108"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>OBS) <span class="op">+</span></span>
<span id="cb15-109"><a href="#cb15-109"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">"Absolute prediction error on day i+1</span><span class="ch">\n</span><span class="st">Using on all data available on day i"</span>)</span>
<span id="cb15-110"><a href="#cb15-110"></a>parameters &lt;-<span class="st"> </span>prosevalDb <span class="op">%&gt;%</span></span>
<span id="cb15-111"><a href="#cb15-111"></a><span class="st">  </span><span class="kw">group_by</span>(ID, OBS) <span class="op">%&gt;%</span></span>
<span id="cb15-112"><a href="#cb15-112"></a><span class="st">  </span><span class="kw">group_modify</span>(<span class="op">~</span><span class="kw"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span>(.x<span class="op">$</span>fit[[<span class="dv">1</span>]], <span class="dt">newdata=</span><span class="dv">0</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="co">#predict time=0</span></span>
<span id="cb15-113"><a href="#cb15-113"></a><span class="st">  </span>tidyr<span class="op">::</span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span>(<span class="dt">key=</span>key, <span class="dt">value=</span>value, Ka<span class="op">:</span>V2) <span class="op">%&gt;%</span></span>
<span id="cb15-114"><a href="#cb15-114"></a><span class="st">  </span><span class="kw">group_by</span>(ID, key) <span class="op">%&gt;%</span></span>
<span id="cb15-115"><a href="#cb15-115"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">relative=</span>(value<span class="op">-</span>value[<span class="dv">1</span>])<span class="op">/</span>value)</span>
<span id="cb15-116"><a href="#cb15-116"></a>parameters <span class="op">%&gt;%</span></span>
<span id="cb15-117"><a href="#cb15-117"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>OBS, <span class="dt">y=</span>relative<span class="op">*</span><span class="dv">100</span>)) <span class="op">+</span></span>
<span id="cb15-118"><a href="#cb15-118"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>key, <span class="dt">scales=</span><span class="st">"free"</span>) <span class="op">+</span></span>
<span id="cb15-119"><a href="#cb15-119"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb15-120"><a href="#cb15-120"></a><span class="st">  </span><span class="kw">geom_line</span>(<span class="kw">aes</span>(<span class="dt">group=</span>ID)) <span class="op">+</span></span>
<span id="cb15-121"><a href="#cb15-121"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">"Evolution of parameter values over time"</span>,</span>
<span id="cb15-122"><a href="#cb15-122"></a>       <span class="dt">y=</span><span class="st">"Relative change (%)"</span>)</span>
<span id="cb15-123"><a href="#cb15-123"></a><span class="kw">ggplot</span>(target, <span class="kw">aes</span>(<span class="dt">x=</span>ipred.CONC <span class="op">/</span><span class="st"> </span>data.CONC)) <span class="op">+</span></span>
<span id="cb15-124"><a href="#cb15-124"></a><span class="st">  </span><span class="kw">stat_ecdf</span>() <span class="op">+</span></span>
<span id="cb15-125"><a href="#cb15-125"></a><span class="st">  </span><span class="kw">scale_x_log10</span>(<span class="dt">limits=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.5</span>, <span class="dv">2</span>)) <span class="op">+</span></span>
<span id="cb15-126"><a href="#cb15-126"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept=</span><span class="dv">1</span>) <span class="op">+</span></span>
<span id="cb15-127"><a href="#cb15-127"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="dt">xintercept=</span><span class="kw"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">0.81</span>, <span class="fl">1.22</span>), <span class="dt">linetype=</span><span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb15-128"><a href="#cb15-128"></a><span class="st">  </span><span class="kw">geom_label</span>(<span class="kw">aes</span>(<span class="dt">x=</span><span class="fl">1.8</span>, <span class="dt">y=</span><span class="fl">0.5</span>, <span class="dt">label=</span>label), <span class="dt">data=</span>. <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(OBS) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarize</span>(<span class="dt">label=</span><span class="kw"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>( <span class="kw"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="kw"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="kw">between</span>(ipred.CONC<span class="op">/</span>data.CONC, <span class="fl">0.81</span>, <span class="fl">1.22</span>))<span class="op">*</span><span class="dv">100</span>), <span class="st">"%"</span>))) <span class="op">+</span></span>
<span id="cb15-129"><a href="#cb15-129"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>OBS) <span class="op">+</span></span>
<span id="cb15-130"><a href="#cb15-130"></a><span class="st">  </span><span class="kw">labs</span>(<span class="dt">title=</span><span class="st">"Relative prediction error on day i+1</span><span class="ch">\n</span><span class="st">Using on all data available on day i"</span>, <span class="dt">caption=</span><span class="st">"White boxes represent % of patients in target"</span>)</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Ruben Faelens, Nicolas Luyckx, Quentin Leirens, FWO TBM Grant.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
